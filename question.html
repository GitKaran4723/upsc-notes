<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UPSC CSE — Practice Questions (Modern)</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#fff7ed',
              100: '#ffedd5',
              200: '#fed7aa',
              300: '#fdba74',
              400: '#fb923c',
              500: '#f97316',
              600: '#ea580c',
              700: '#c2410c',
              800: '#9a3412',
              900: '#7c2d12'
            }
          },
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,0.08)'
          }
        }
      }
    }
  </script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <!-- Markdown renderer & sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>

  <style>
    html { scroll-behavior: smooth; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .glass { background: rgba(255,255,255,0.75); backdrop-filter: blur(10px); }
    .pressed { transform: translateY(1px); }
    body.modal-open { overflow: hidden; }

    .fade-in { animation: fade-in .25s ease-out; }
    @keyframes fade-in { from { opacity: 0 } to { opacity: 1 } }

    .slide-up { animation: slide-up .25s ease-out; }
    @keyframes slide-up { from { transform: translateY(8px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }

    .wiki-keyword { color: #1d4ed8; text-decoration: underline; cursor: pointer; }
    .wiki-keyword:hover { color: #2563eb; text-decoration: none; }

    /* Bottom sheet */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.45); display: none; z-index: 60; }
    .bottom-sheet {
      position: fixed; left: 50%; bottom: 1.25rem; transform: translateX(-50%);
      width: min(92%, 720px); max-height: 70vh; overflow: auto;
      background: #fff; border-radius: 16px; padding: 1rem 1rem 1.25rem;
      box-shadow: 0 20px 60px rgba(0,0,0,.25); display: none; z-index: 70;
      animation: sheet-in .22s ease-out;
    }
    @keyframes sheet-in { from { transform: translate(-50%, 12px); opacity: 0 } to { transform: translate(-50%, 0); opacity: 1 } }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-amber-50 via-white to-amber-100 text-gray-900 selection:bg-amber-200/60">
  <!-- Loader -->
  <div id="loader" class="fixed inset-0 z-[100] flex items-center justify-center bg-white/90">
    <div class="text-center text-brand-800">
      <div class="text-xl font-semibold mb-3">Preparing your practice…</div>
      <div class="w-12 h-12 border-4 border-amber-400 border-t-transparent rounded-full animate-spin mx-auto"></div>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-50 glass border-b border-amber-200/70">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3 justify-between">
      <div class="flex items-center gap-3">
        <div class="p-2 rounded-xl bg-amber-100 text-amber-700">
          <i class="fa-solid fa-graduation-cap"></i>
        </div>
        <div>
          <h1 class="text-lg sm:text-xl font-bold tracking-wide">UPSC CSE — Practice Questions</h1>
          <p id="date-info" class="text-xs sm:text-sm text-gray-600"></p>
        </div>
      </div>
      <a href="/upsc-notes/practice.html" class="hidden sm:inline text-sm text-gray-700 hover:text-amber-700">
        Back to Dates
      </a>
    </div>
  </header>

  <!-- Progress + mini toolbar -->
  <section class="max-w-5xl mx-auto px-4 mt-3">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-2 text-sm text-gray-700">
        <span id="counter">0 / 0</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="reset-session" class="inline-flex items-center gap-2 rounded-lg bg-white border border-amber-300 px-3 py-2 text-sm hover:bg-amber-50">
          <i class="fa-solid fa-rotate"></i><span class="hidden sm:inline">Reset</span>
        </button>
      </div>
    </div>
    <div class="mt-3 h-2 w-full bg-amber-100 rounded-full overflow-hidden">
      <div id="progress-bar" class="h-full bg-amber-500 transition-all" style="width:0%"></div>
    </div>
  </section>

  <!-- Carousel -->
  <main class="relative max-w-5xl mx-auto px-4 mt-4">
    <div id="question-carousel" class="no-scrollbar h-[calc(100vh-240px)] overflow-y-auto pb-28"></div>

    <!-- Bottom Controls -->
    <div class="fixed bottom-0 left-0 right-0 z-40 glass border-t border-amber-200/70">
      <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
        <button id="prev-btn" class="inline-flex items-center gap-2 rounded-lg bg-gray-800 text-white px-4 py-2 shadow-soft disabled:opacity-40 disabled:cursor-not-allowed">
          <i class="fa-solid fa-arrow-left"></i><span class="hidden sm:inline">Prev</span>
        </button>

        <div class="flex items-center gap-2 text-xs text-gray-600">
          <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span>Correct</span>
          <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span>Wrong</span>
          <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-amber-400 inline-block"></span>Unanswered</span>
        </div>

        <button id="next-btn" class="inline-flex items-center gap-2 rounded-lg bg-gray-800 text-white px-4 py-2 shadow-soft disabled:opacity-40 disabled:cursor-not-allowed">
          <span class="hidden sm:inline">Next</span><i class="fa-solid fa-arrow-right"></i>
        </button>
      </div>
    </div>
  </main>

  <!-- Explanation Modal -->
  <div id="solution-modal" class="hidden fixed inset-0 bg-black/50 items-center justify-center z-[60]" aria-hidden="true">
    <div role="dialog" aria-modal="true" aria-labelledby="modal-title" class="bg-white w-[92%] md:max-w-xl rounded-2xl shadow-xl relative p-5 md:p-6 max-h-[90vh] overflow-y-auto slide-up">
      <button id="modal-close" class="absolute top-3 right-3 text-gray-600 text-xl" aria-label="Close">
        <i class="fas fa-times"></i>
      </button>
      <h3 id="modal-title" class="text-lg font-bold mb-3 text-gray-800">Explanation</h3>
      <div id="modal-content" class="prose prose-sm max-w-none"></div>
    </div>
  </div>

  <!-- Wiki Bottom Sheet -->
  <div id="overlay" class="overlay" onclick="closeWikiPopup()"></div>
  <div id="wikiPopup" class="bottom-sheet">
    <div class="flex items-start justify-between gap-3 mb-2">
      <h2 id="wikiTitle" class="text-lg font-semibold text-gray-800">Loading…</h2>
      <button onclick="closeWikiPopup()" class="px-2 py-1 text-gray-500 hover:text-gray-700" aria-label="Close wiki pane">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <p id="wikiContent" class="text-sm text-gray-700 leading-6">Please wait…</p>
    <div class="mt-3 text-xs text-gray-500" id="wikiAttribution"></div>
  </div>

  <script>
    // =========================
    // Temporary in-memory state
    // =========================
    const session = {
      data: [],            // questions
      index: 0,            // current index
      answers: new Map(),  // id -> { selectedText, correct, correctText }
    };

    // =========================
    // Elements
    // =========================
    const container = document.getElementById('question-carousel');
    const modal = document.getElementById('solution-modal');
    const modalClose = document.getElementById('modal-close');
    const modalContent = document.getElementById('modal-content');

    const dateInfo = document.getElementById('date-info');
    const loader = document.getElementById('loader');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const counter = document.getElementById('counter');
    const progressBar = document.getElementById('progress-bar');

    // Wiki elements
    const wikiOverlay = document.getElementById('overlay');
    const wikiPopup = document.getElementById('wikiPopup');
    const wikiTitleEl = document.getElementById('wikiTitle');
    const wikiContentEl = document.getElementById('wikiContent');
    const wikiAttribEl = document.getElementById('wikiAttribution');

    // =========================
    // Helpers
    // =========================
    function getUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        year: urlParams.get('year'),
        month: urlParams.get('month'),
        date: urlParams.get('date')
      };
    }

    function sanitizeHTML(html) {
      return DOMPurify.sanitize(html, {
        ALLOWED_ATTR: ['href','target','rel','src','alt','title']
      });
    }

    function renderMarkdown(md) {
      const raw = marked.parse(md || '');
      // Add [[Wiki Term]] enrichment before sanitization
      const enriched = raw.replace(/\[\[(.*?)\]\]/g, (match, title) => {
        return `<span class="wiki-keyword" onclick="showWikiContent('${title.replace(/'/g, "\\'")}')">${title}</span>`;
      });
      return sanitizeHTML(enriched);
    }

    function updateHeader() {
      const { year, month, date } = getUrlParams();
      dateInfo.textContent = `📅 Practice Date: ${date || '—'} ${month || ''}, ${year || ''}`.trim();
    }

    function updateProgressUI() {
      const total = session.data.length;
      counter.textContent = `${Math.min(session.index + 1, total)} / ${total}`;
      const attempted = Array.from(session.answers.values()).filter(v => v.selectedText != null).length;
      const pct = total ? Math.round((attempted / total) * 100) : 0;
      progressBar.style.width = pct + '%';

      prevBtn.disabled = session.index <= 0;
      nextBtn.disabled = session.index >= total - 1 || total === 0;
    }

    function applyPressed(el) {
      el.classList.add('pressed');
      setTimeout(() => el.classList.remove('pressed'), 120);
    }

    // =========================
    // Render Question
    // =========================
    function renderQuestion(q, idx) {
      const card = document.createElement('div');
      card.className = 'bg-white shadow-soft rounded-2xl p-6 md:p-7 fade-in border border-amber-100';

      // Tags
      if (q.tags) {
        const tagWrap = document.createElement('div');
        tagWrap.className = 'flex flex-wrap gap-2 mb-4';
        const tagColors = [
          ['bg-pink-100','text-pink-800'],['bg-purple-100','text-purple-800'],
          ['bg-green-100','text-green-800'],['bg-blue-100','text-blue-800'],
          ['bg-red-100','text-red-800'],['bg-yellow-100','text-yellow-800'],
          ['bg-indigo-100','text-indigo-800'],['bg-teal-100','text-teal-800'],
          ['bg-rose-100','text-rose-800'],['bg-orange-100','text-orange-800'],
        ];
        (q.tags.split(',').map(t=>t.trim())).forEach(tag => {
          const chip = document.createElement('span');
          const [bg, txt] = tagColors[Math.floor(Math.random()*tagColors.length)];
          chip.className = `${bg} ${txt} text-xs font-medium px-2.5 py-0.5 rounded-full`;
          chip.textContent = tag;
          tagWrap.appendChild(chip);
        });
        card.appendChild(tagWrap);
      }

      // Title
      const h = document.createElement('h3');
      h.className = 'text-lg font-semibold text-gray-800';
      h.textContent = `Q${idx + 1}. ${q.question}`;
      card.appendChild(h);

      // Statements
      if (Array.isArray(q.statements) && q.statements.length) {
        const list = document.createElement('ol');
        list.className = 'list-decimal pl-6 mt-3 space-y-1 text-[15px] text-gray-800';
        q.statements.forEach(s => {
          const li = document.createElement('li');
          li.textContent = s;
          list.appendChild(li);
        });
        card.appendChild(list);
      }

      // Options
      const optionsDiv = document.createElement('div');
      optionsDiv.className = 'mt-4 space-y-2';
      let answeredObj = session.answers.get(idx) || { selectedText: null, correct: null, correctText: q.correct_option };

      q.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.textContent = opt;
        btn.className = 'block w-full text-left px-4 py-3 text-[15px] rounded-xl border border-amber-200 bg-amber-50 hover:bg-amber-100 transition-colors';
        optionsDiv.appendChild(btn);

        if (answeredObj.selectedText != null) {
          btn.disabled = true;
          btn.classList.remove('hover:bg-amber-100');
          if (opt === answeredObj.selectedText && answeredObj.correct) {
            btn.classList.add('bg-green-100','border-green-300');
          } else if (opt === answeredObj.selectedText && !answeredObj.correct) {
            btn.classList.add('bg-red-100','border-red-300');
          } else if (opt === answeredObj.correctText) {
            btn.classList.add('bg-green-50','border-green-200');
          }
        }

        btn.onclick = () => {
          if (session.answers.get(idx)?.selectedText != null) return;

          const isCorrect = opt === q.correct_option;
          answeredObj = { selectedText: opt, correct: isCorrect, correctText: q.correct_option };
          session.answers.set(idx, answeredObj);

          // Freeze + colorize
          Array.from(optionsDiv.children).forEach(b => {
            b.disabled = true;
            b.classList.remove('hover:bg-amber-100');
            const text = b.textContent;
            if (text === opt && isCorrect) {
              b.classList.add('bg-green-100','border-green-300');
            } else if (text === opt && !isCorrect) {
              b.classList.add('bg-red-100','border-red-300');
            } else if (text === q.correct_option) {
              b.classList.add('bg-green-50','border-green-200');
            }
          });

          // Feedback
          feedback.textContent = isCorrect ? '✅ Correct!' : `❌ Wrong! Correct Answer: ${q.correct_option}`;
          feedback.className = isCorrect ? 'text-green-700 mt-3 text-sm font-semibold' : 'text-red-700 mt-3 text-sm font-semibold';
          expBtn.classList.remove('hidden');

          updateProgressUI();
        };
      });

      card.appendChild(optionsDiv);

      // Feedback + explanation
      const feedback = document.createElement('p');
      if (answeredObj.selectedText != null) {
        feedback.textContent = answeredObj.correct ? '✅ Correct!' : `❌ Wrong! Correct Answer: ${q.correct_option}`;
        feedback.className = answeredObj.correct ? 'text-green-700 mt-3 text-sm font-semibold' : 'text-red-700 mt-3 text-sm font-semibold';
      } else {
        feedback.className = 'mt-3 text-sm text-gray-500';
        feedback.textContent = 'Select an option to check your answer.';
      }
      card.appendChild(feedback);

      const expBtn = document.createElement('button');
      expBtn.className = 'mt-3 inline-flex items-center gap-2 rounded-lg bg-amber-600 hover:bg-amber-700 text-white px-3 py-2 text-sm ' + (answeredObj.selectedText != null ? '' : 'hidden');
      expBtn.innerHTML = '<i class="fa-solid fa-lightbulb"></i><span>View Explanation</span>';
      expBtn.addEventListener('click', () => openModal(renderMarkdown(q.explanation || 'No explanation provided.')));
      card.appendChild(expBtn);

      return card;
    }

    function renderPage() {
      container.innerHTML = '';
      if (!session.data.length) {
        container.innerHTML = `<p class="text-center text-red-600 mt-6">⚠️ No questions found.</p>`;
        return;
      }
      const card = renderQuestion(session.data[session.index], session.index);
      container.appendChild(card);
      updateProgressUI();
    }

    // =========================
    // Modal controls
    // =========================
    function openModal(html) {
      modalContent.innerHTML = html;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.classList.add('modal-open');
      modal.setAttribute('aria-hidden', 'false');
      document.getElementById('modal-close').focus();
    }
    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.classList.remove('modal-open');
      modal.setAttribute('aria-hidden', 'true');
    }
    document.getElementById('modal-close').addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal(); });

    // =========================
    // Navigation
    // =========================
    prevBtn.addEventListener('click', () => { applyPressed(prevBtn); if (session.index > 0) { session.index--; renderPage(); } });
    nextBtn.addEventListener('click', () => { applyPressed(nextBtn); if (session.index < session.data.length - 1) { session.index++; renderPage(); } });

    // Swipe
    let touchStartX = 0;
    container.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, { passive: true });
    container.addEventListener('touchend', e => {
      const diffX = e.changedTouches[0].clientX - touchStartX;
      if (diffX > 50 && session.index > 0) { session.index--; renderPage(); }
      else if (diffX < -50 && session.index < session.data.length - 1) { session.index++; renderPage(); }
    }, { passive: true });

    // Keyboard
    window.addEventListener('keydown', (e) => {
      if (!modal.classList.contains('hidden')) return;
      if (e.key === 'ArrowLeft') { if (session.index > 0) { session.index--; renderPage(); } }
      if (e.key === 'ArrowRight') { if (session.index < session.data.length - 1) { session.index++; renderPage(); } }
    });

    // Reset session
    document.getElementById('reset-session').addEventListener('click', () => {
      applyPressed(document.getElementById('reset-session'));
      if (!confirm('Reset current session (answers will be cleared)?')) return;
      session.answers.clear();
      session.index = 0;
      renderPage();
    });

    // =========================
    // Wiki integration (works cross-origin via origin=*)
    // =========================
    async function showWikiContent(title) {
      const apiUrl = `https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&titles=${encodeURIComponent(title)}&format=json&origin=*`;

      // Show sheet + loading state
      wikiTitleEl.textContent = 'Loading…';
      wikiContentEl.textContent = 'Please wait…';
      wikiAttribEl.textContent = '';
      wikiOverlay.style.display = 'block';
      wikiPopup.style.display = 'block';

      try {
        const res = await fetch(apiUrl, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('Network error');
        const data = await res.json();
        const page = Object.values(data?.query?.pages || {})[0];

        if (!page || page.missing === '' || !page.extract) {
          wikiTitleEl.textContent = title;
          wikiContentEl.textContent = 'No content found.';
          wikiAttribEl.innerHTML = '';
          return;
        }

        wikiTitleEl.textContent = page.title || title;
        wikiContentEl.textContent = page.extract;
        wikiAttribEl.innerHTML = `Source: Wikipedia — <a href="https://en.wikipedia.org/wiki/${encodeURIComponent(page.title)}" target="_blank" rel="noopener noreferrer" class="text-blue-700 underline">open full article</a>`;
      } catch (err) {
        console.error(err);
        wikiTitleEl.textContent = 'Error';
        wikiContentEl.textContent = 'Failed to load content.';
        wikiAttribEl.textContent = '';
      }
    }
    window.showWikiContent = showWikiContent; // make available for onclick

    function closeWikiPopup() {
      wikiOverlay.style.display = 'none';
      wikiPopup.style.display = 'none';
    }
    window.closeWikiPopup = closeWikiPopup;

    // =========================
    // Load Questions
    // =========================
    async function loadQuestions() {
      updateHeader();
      const { year, month, date } = getUrlParams();

      try {
        const res = await fetch(`./question/practice/${year}/${month}/${date}.json`, { cache: 'no-store' });
        const data = await res.json();

        // Normalize minimal
        session.data = (data || []).map((q) => ({
          ...q,
          question: String(q.question || '').trim(),
          options: Array.isArray(q.options) ? q.options.slice() : [],
          correct_option: q.correct_option
        }));

        loader.classList.add('hidden');
        renderPage();
      } catch (error) {
        console.error('Error loading questions:', error);
        loader.classList.add('hidden');
        container.innerHTML = `<p class='text-red-600 text-center mt-6'>Questions Coming Soon or failed to load.</p>`;
      }
    }

    document.addEventListener('DOMContentLoaded', loadQuestions);
  </script>
</body>
</html>
