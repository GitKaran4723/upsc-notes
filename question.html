<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UPSC CSE — Practice Questions (Modern)</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#fef3e2',
              100: '#fde7c5',
              200: '#fbcf8b',
              300: '#f9b751',
              400: '#f7a027',
              500: '#f59e0b',
              600: '#d97706',
              700: '#b45309',
              800: '#92400e',
              900: '#78350f',
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'float': 'float 3s ease-in-out infinite',
            'glow': 'glow 2s ease-in-out infinite alternate',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-20px)' },
            },
            glow: {
              '0%': { boxShadow: '0 0 5px rgba(245, 158, 11, 0.5)' },
              '100%': { boxShadow: '0 0 20px rgba(245, 158, 11, 0.8)' },
            },
          },
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,0.08)'
          }
        }
      }
    }
  </script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <link rel="stylesheet" href="/upsc-notes/assets/ui.css">

  <!-- Markdown renderer & sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>

  <style>
    html { scroll-behavior: smooth; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .glass-effect { 
      background: rgba(255,255,255,0.1); 
      backdrop-filter: blur(10px); 
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .dark .glass-effect {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .gradient-text {
      background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .glass { background: rgba(255,255,255,0.75); backdrop-filter: blur(10px); }
    .pressed { transform: translateY(1px); }
    body.modal-open { overflow: hidden; }

    .fade-in { animation: fade-in .25s ease-out; }
    @keyframes fade-in { from { opacity: 0 } to { opacity: 1 } }

    .slide-up { animation: slide-up .25s ease-out; }
    @keyframes slide-up { from { transform: translateY(8px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }

    .wiki-keyword { color: #1d4ed8; text-decoration: underline; cursor: pointer; }
    .wiki-keyword:hover { color: #2563eb; text-decoration: none; }

    /* Bottom sheet */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.45); display: none; z-index: 60; }
    .bottom-sheet {
      position: fixed; left: 50%; bottom: 1.25rem; transform: translateX(-50%);
      width: min(92%, 720px); max-height: 70vh; overflow: auto;
      background: #fff; border-radius: 16px; padding: 1rem 1rem 1.25rem;
      box-shadow: 0 20px 60px rgba(0,0,0,.25); display: none; z-index: 70;
      animation: sheet-in .22s ease-out;
    }
    .dark .bottom-sheet {
      background: #1f2937;
    }
    @keyframes sheet-in { from { transform: translate(-50%, 12px); opacity: 0 } to { transform: translate(-50%, 0); opacity: 1 } }

    /* SUPERB ANIMATIONS */
    .card-enter { animation: card-enter 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes card-enter {
      0% { opacity: 0; transform: scale(0.8) rotateX(-15deg) translateY(50px); }
      100% { opacity: 1; transform: scale(1) rotateX(0) translateY(0); }
    }

    .option-btn {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      transform-style: preserve-3d;
      position: relative;
      overflow: hidden;
    }

    .option-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,0.3), transparent);
      transform: translateX(-100%);
      transition: transform 0.6s;
    }

    .option-btn:hover::before {
      transform: translateX(100%);
    }

    .option-btn:hover:not(:disabled) {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 12px 24px rgba(245, 158, 11, 0.3);
    }

    .option-btn:active:not(:disabled) {
      transform: translateY(-2px) scale(0.98);
    }

    .option-correct {
      animation: correct-bounce 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
      color: white !important;
      border-color: #059669 !important;
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
    }

    .option-wrong {
      animation: wrong-shake 0.6s cubic-bezier(0.36, 0.07, 0.19, 0.97);
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
      color: white !important;
      border-color: #dc2626 !important;
      box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
    }

    .option-reveal {
      animation: reveal-glow 0.8s ease-out;
      background: linear-gradient(135deg, #6ee7b7 0%, #34d399 100%) !important;
      border-color: #10b981 !important;
    }

    @keyframes correct-bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-20px); }
      60% { transform: translateY(-10px); }
    }

    @keyframes wrong-shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
      20%, 40%, 60%, 80% { transform: translateX(8px); }
    }

    @keyframes reveal-glow {
      0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.8); }
      50% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); }
      100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    .confetti-burst {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 9999;
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #f59e0b;
      animation: confetti-fall 1.5s ease-out forwards;
    }

    @keyframes confetti-fall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(300px) rotate(720deg); opacity: 0; }
    }

    .streak-indicator {
      animation: streak-pulse 0.6s ease-out;
    }

    @keyframes streak-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .progress-celebrate {
      animation: progress-shine 1s ease-in-out;
    }

    @keyframes progress-shine {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.5) drop-shadow(0 0 12px rgba(245, 158, 11, 0.8)); }
    }

    .saved-badge {
      position: fixed;
      top: 100px;
      right: 20px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
      animation: badge-slide-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 9999;
    }

    @keyframes badge-slide-in {
      0% { transform: translateX(400px); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }

    .delete-confirmation {
      animation: modal-bounce 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes modal-bounce {
      0% { transform: scale(0.7); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Question Grid Items */
    .question-number {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      border: 2px solid transparent;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .question-number:hover {
      transform: translateY(-3px) scale(1.1);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .question-number:active {
      transform: scale(0.95);
    }

    .question-number.unattempted {
      background: #f3f4f6;
      color: #6b7280;
      border-color: #e5e7eb;
    }

    .dark .question-number.unattempted {
      background: #374151;
      color: #9ca3af;
      border-color: #4b5563;
    }

    .question-number.correct {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-color: #059669;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .question-number.wrong {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border-color: #dc2626;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .question-number.active {
      border-color: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
      transform: scale(1.15);
    }

    /* Mobile Bottom Sheet */
    #mobile-bottom-sheet.sheet-open {
      transform: translateY(0);
    }

    #mobile-bottom-sheet-overlay.overlay-open {
      opacity: 1;
    }

    /* Floating Action Button Pulse */
    #mobile-menu-fab {
      animation: fab-pulse 2s ease-in-out infinite;
    }

    @keyframes fab-pulse {
      0%, 100% { box-shadow: 0 8px 24px rgba(245, 158, 11, 0.4); }
      50% { box-shadow: 0 8px 32px rgba(245, 158, 11, 0.7), 0 0 0 8px rgba(245, 158, 11, 0.1); }
    }

    /* Mobile improvements */
    @media (max-width: 1024px) {
      .question-number {
        width: 40px;
        height: 40px;
        font-size: 14px;
      }

      #mobile-question-grid .question-number {
        width: 44px;
        height: 44px;
        font-size: 15px;
      }
    }

    /* Fix scrolling issues */
    html, body {
      overflow: hidden;
      height: 100%;
      width: 100%;
      position: fixed;
    }

    #quiz-container {
      overflow: hidden;
    }

    #question-navigator {
      -webkit-overflow-scrolling: touch;
    }

    .overflow-y-auto {
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 via-orange-50 to-amber-50 dark:from-gray-900 dark:via-gray-800 dark:to-slate-900 text-gray-900 dark:text-gray-100 selection:bg-amber-200/60 transition-colors duration-300">
  <!-- Animated Background Elements (index-style) -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
    <div class="absolute top-20 left-10 w-72 h-72 bg-amber-300/20 dark:bg-amber-500/10 rounded-full blur-3xl animate-float"></div>
    <div class="absolute bottom-20 right-10 w-96 h-96 bg-orange-300/20 dark:bg-orange-500/10 rounded-full blur-3xl animate-float" style="animation-delay: 1s;"></div>
    <div class="absolute top-1/2 left-1/2 w-80 h-80 bg-yellow-300/10 dark:bg-yellow-500/5 rounded-full blur-3xl animate-float" style="animation-delay: 2s;"></div>
  </div>

  <!-- Navbar (index-style) -->
  <header class="glass-effect backdrop-blur-lg bg-white/80 dark:bg-gray-900/80 shadow-lg sticky top-0 z-50 border-b border-gray-200/50 dark:border-gray-700/50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center shadow-lg animate-glow">
            <i class="fas fa-calendar-alt text-white text-xl"></i>
          </div>
          <div>
            <h1 id="navbar-date-display" class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">
              Practice Quiz
            </h1>
            <p id="navbar-date-subtitle" class="text-xs text-gray-600 dark:text-gray-400">
              Loading...
            </p>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <button id="themeToggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
            <i class="fas fa-moon dark:fa-sun text-gray-700 dark:text-gray-300"></i>
          </button>
          <button id="menuToggle" class="lg:hidden text-2xl focus:outline-none p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors">
            <i id="menuIcon" class="fas fa-bars text-gray-700 dark:text-gray-300"></i>
          </button>
          <nav class="hidden lg:flex gap-1 font-medium">
            <a href="/upsc-notes/" class="px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300 transition-all">Home</a>
            <a href="/upsc-notes/practice.html" class="px-4 py-2 rounded-lg bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 font-semibold transition-all">Back to Practice</a>
            <a href="/upsc-notes/subjectpractice.html" class="px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300 transition-all">Subjects</a>
            <a href="/upsc-notes/pyq.html" class="px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300 transition-all">PYQs</a>
          </nav>
        </div>
      </div>
    </div>
  </header>
  <!-- Fullscreen Prompt -->
  <div id="fullscreen-prompt" class="fixed inset-0 z-[110] flex items-center justify-center bg-gradient-to-br from-gray-900 via-gray-800 to-slate-900">
    <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-8 max-w-md mx-4 text-center animate-fade-in">
      <div class="w-20 h-20 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-float">
        <i class="fas fa-expand text-white text-3xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-3">Enter Fullscreen Mode</h2>
      <p class="text-gray-600 dark:text-gray-300 mb-6">Get the best quiz experience in fullscreen mode. Focus better, score higher!</p>
      <div class="space-y-3">
        <button id="enter-fullscreen" class="w-full inline-flex items-center justify-center gap-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white px-6 py-4 text-lg font-semibold shadow-lg transition-all hover:scale-105">
          <i class="fas fa-expand-arrows-alt"></i>
          <span>Start in Fullscreen</span>
        </button>
        <button id="skip-fullscreen" class="w-full inline-flex items-center justify-center gap-2 rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 text-sm font-medium transition-all">
          <span>Continue Without Fullscreen</span>
        </button>
      </div>
      <p class="text-xs text-gray-500 dark:text-gray-400 mt-4">Press <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded">F11</kbd> anytime to toggle fullscreen</p>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-white/90 dark:bg-gray-900/90">
    <div class="text-center">
      <div class="text-xl font-semibold mb-3 text-gray-800 dark:text-white">Preparing your practice…</div>
      <div class="w-12 h-12 border-4 border-amber-400 border-t-transparent rounded-full animate-spin mx-auto"></div>
    </div>
  </div>

  <!-- Floating Action Button (Mobile Only) -->
  <button id="mobile-menu-fab" class="lg:hidden fixed bottom-24 right-4 z-50 w-14 h-14 rounded-full bg-gradient-to-r from-amber-500 to-orange-600 shadow-2xl flex items-center justify-center text-white text-xl hover:scale-110 active:scale-95 transition-all hidden">
    <i class="fas fa-grip-vertical"></i>
  </button>

  <!-- Full Screen Quiz Container -->
  <div id="quiz-container" class="fixed inset-0 flex hidden">
    <!-- Left Sidebar - Question Navigator (Desktop) -->
    <aside id="question-navigator" class="hidden lg:block w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 overflow-y-auto h-full shadow-xl">
      <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4 z-10">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-bold text-gray-800 dark:text-white">Questions</h2>
          <button id="close-nav-mobile" class="lg:hidden text-gray-600 dark:text-gray-300 hover:text-amber-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <p id="date-info" class="text-xs text-gray-600 dark:text-gray-400 mb-3"></p>
        <div class="flex items-center gap-2 text-xs">
          <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span>Correct</span>
          <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span>Wrong</span>
          <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-gray-300 dark:bg-gray-600"></span>Unattempted</span>
        </div>
      </div>
      
      <div id="question-grid" class="grid grid-cols-6 gap-2 p-4">
        <!-- Question numbers will be dynamically added here -->
      </div>

      <div class="sticky bottom-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4">
        <div class="space-y-2 mb-3">
          <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400">
            <span>Score:</span>
            <span class="font-bold text-amber-600 dark:text-amber-400"><span id="score-display">0</span> / <span id="total-questions">0</span></span>
          </div>
          <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400">
            <span>Accuracy:</span>
            <span class="font-bold text-green-600 dark:text-green-400" id="accuracy-display">0%</span>
          </div>
        </div>
        <div class="h-2 w-full bg-amber-100 dark:bg-amber-900/30 rounded-full overflow-hidden shadow-inner mb-3">
          <div id="progress-bar" class="h-full bg-gradient-to-r from-amber-500 via-orange-500 to-red-500 transition-all duration-500" style="width:0%"></div>
        </div>
        <div class="space-y-2">
          <button id="clear-data-btn" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-red-500 hover:bg-red-600 text-white px-3 py-2 text-sm transition-all shadow-md">
            <i class="fa-solid fa-trash"></i><span>Clear Data</span>
          </button>
          <button id="reset-session" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-white dark:bg-gray-700 border border-amber-300 dark:border-amber-600 px-3 py-2 text-sm hover:bg-amber-50 dark:hover:bg-gray-600 transition-all">
            <i class="fa-solid fa-rotate"></i><span>Reset Session</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content Area - Full Screen Question -->
    <main class="flex-1 overflow-y-auto relative">
      <!-- Top Bar with Stats -->
      <div class="sticky top-0 z-30 glass-effect backdrop-blur-lg bg-white/90 dark:bg-gray-900/90 border-b border-gray-200 dark:border-gray-700 px-4 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <button id="toggle-nav" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
              <i class="fas fa-bars text-gray-700 dark:text-gray-300"></i>
            </button>
            <div class="flex items-center gap-2">
              <span id="counter" class="text-sm font-bold text-gray-800 dark:text-white">0 / 0</span>
              <span id="streak-indicator" class="px-2 py-1 bg-gradient-to-r from-orange-400 to-red-500 text-white rounded-full text-xs font-bold hidden">
                🔥 <span id="streak-count">0</span> Streak!
              </span>
            </div>
          </div>
          <a href="/upsc-notes/practice.html" class="text-sm text-gray-700 dark:text-gray-300 hover:text-amber-600 dark:hover:text-amber-400 transition-colors">
            <i class="fas fa-arrow-left mr-1"></i><span class="hidden sm:inline">Back to Dates</span>
          </a>
        </div>
      </div>

      <!-- Question Display Area -->
      <div class="h-[calc(100vh-8rem)] overflow-y-auto">
        <div id="question-carousel" class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6"></div>
      </div>

      <!-- Bottom Navigation -->
      <div class="fixed bottom-0 left-0 lg:left-72 right-0 z-30 glass-effect backdrop-blur-lg bg-white/90 dark:bg-gray-900/90 border-t border-gray-200 dark:border-gray-700 px-4 py-3 lg:py-4">
        <div class="max-w-4xl mx-auto flex items-center justify-between gap-2 sm:gap-3">
          <button id="prev-btn" class="inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-gray-700 to-gray-900 dark:from-gray-600 dark:to-gray-800 text-white px-4 sm:px-6 py-2.5 sm:py-3 shadow-lg disabled:opacity-40 disabled:cursor-not-allowed transition-all hover:scale-105 disabled:hover:scale-100 text-sm sm:text-base">
            <i class="fa-solid fa-arrow-left"></i><span class="hidden sm:inline">Previous</span>
          </button>

          <div class="flex items-center gap-1 sm:gap-2">
            <button id="jump-first" class="p-2 sm:p-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-gray-700 dark:text-gray-300 text-sm sm:text-base" title="First Question">
              <i class="fas fa-fast-backward"></i>
            </button>
            <button id="exit-fullscreen-btn" class="p-2 sm:p-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-gray-700 dark:text-gray-300 text-sm sm:text-base hidden" title="Exit Fullscreen">
              <i class="fas fa-compress"></i>
            </button>
            <button id="jump-last" class="p-2 sm:p-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-gray-700 dark:text-gray-300 text-sm sm:text-base" title="Last Question">
              <i class="fas fa-fast-forward"></i>
            </button>
          </div>

          <button id="next-btn" class="inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white px-4 sm:px-6 py-2.5 sm:py-3 shadow-lg disabled:opacity-40 disabled:cursor-not-allowed transition-all hover:scale-105 disabled:hover:scale-100 text-sm sm:text-base">
            <span class="hidden sm:inline">Next</span><i class="fa-solid fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Bottom Sheet (iOS Style) -->
  <div id="mobile-bottom-sheet-overlay" class="lg:hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden transition-opacity duration-300" onclick="closeMobileSheet()"></div>
  
  <div id="mobile-bottom-sheet" class="lg:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 rounded-t-3xl shadow-2xl z-[70] transform translate-y-full transition-transform duration-300 ease-out max-h-[85vh] flex flex-col">
    <!-- Handle Bar -->
    <div class="flex justify-center py-3 border-b border-gray-200 dark:border-gray-700">
      <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
    </div>
    
    <!-- Header -->
    <div class="px-5 py-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-bold text-gray-900 dark:text-white">Question Navigator</h2>
        <button onclick="closeMobileSheet()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
          <i class="fas fa-times text-gray-600 dark:text-gray-300"></i>
        </button>
      </div>
      <p id="date-info-mobile" class="text-xs text-gray-600 dark:text-gray-400 mb-3"></p>
      <div class="flex items-center gap-3 text-xs flex-wrap">
        <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-full bg-green-500"></span>Correct</span>
        <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-full bg-red-500"></span>Wrong</span>
        <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-full bg-gray-300 dark:bg-gray-600"></span>Unattempted</span>
      </div>
    </div>

    <!-- Questions Grid (Scrollable) -->
    <div class="flex-1 overflow-y-auto p-5">
      <div id="mobile-question-grid" class="grid grid-cols-6 gap-2.5">
        <!-- Question numbers will be dynamically added here -->
      </div>
    </div>

    <!-- Footer Actions -->
    <div class="px-5 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 space-y-3">
      <div class="grid grid-cols-2 gap-2 text-xs text-gray-600 dark:text-gray-400">
        <div class="flex justify-between">
          <span>Score:</span>
          <span class="font-bold text-amber-600 dark:text-amber-400"><span id="mobile-score-display">0</span> / <span id="mobile-total-questions">0</span></span>
        </div>
        <div class="flex justify-between">
          <span>Accuracy:</span>
          <span class="font-bold text-green-600 dark:text-green-400" id="mobile-accuracy-display">0%</span>
        </div>
      </div>
      <div class="h-2 w-full bg-amber-100 dark:bg-amber-900/30 rounded-full overflow-hidden shadow-inner">
        <div id="mobile-progress-bar" class="h-full bg-gradient-to-r from-amber-500 via-orange-500 to-red-500 transition-all duration-500" style="width:0%"></div>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <button id="mobile-clear-data-btn" class="inline-flex items-center justify-center gap-2 rounded-xl bg-red-500 hover:bg-red-600 active:scale-95 text-white px-4 py-3 text-sm font-semibold transition-all shadow-lg">
          <i class="fa-solid fa-trash"></i><span>Clear Data</span>
        </button>
        <button id="mobile-reset-session" class="inline-flex items-center justify-center gap-2 rounded-xl bg-white dark:bg-gray-700 border-2 border-amber-300 dark:border-amber-600 hover:bg-amber-50 dark:hover:bg-gray-600 active:scale-95 px-4 py-3 text-sm font-semibold transition-all text-gray-900 dark:text-white">
          <i class="fa-solid fa-rotate"></i><span>Reset</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Explanation Modal -->
  <div id="solution-modal" class="hidden fixed inset-0 bg-black/50 items-center justify-center z-[60]" aria-hidden="true">
    <div role="dialog" aria-modal="true" aria-labelledby="modal-title" class="bg-white w-[92%] md:max-w-xl rounded-2xl shadow-xl relative p-5 md:p-6 max-h-[90vh] overflow-y-auto slide-up">
      <button id="modal-close" class="absolute top-3 right-3 text-gray-600 text-xl" aria-label="Close">
        <i class="fas fa-times"></i>
      </button>
      <h3 id="modal-title" class="text-lg font-bold mb-3 text-gray-800">Explanation</h3>
      <div id="modal-content" class="prose prose-sm max-w-none"></div>
    </div>
  </div>

  <!-- Wiki Bottom Sheet -->
  <div id="overlay" class="overlay" onclick="closeWikiPopup()"></div>
  <div id="wikiPopup" class="bottom-sheet">
    <div class="flex items-start justify-between gap-3 mb-2">
      <h2 id="wikiTitle" class="text-lg font-semibold text-gray-800">Loading…</h2>
      <button onclick="closeWikiPopup()" class="px-2 py-1 text-gray-500 hover:text-gray-700" aria-label="Close wiki pane">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <p id="wikiContent" class="text-sm text-gray-700 leading-6">Please wait…</p>
    <div class="mt-3 text-xs text-gray-500" id="wikiAttribution"></div>
  </div>

  <script>
    // =========================
    // LOCAL STORAGE KEY MANAGEMENT
    // =========================
    function getStorageKey() {
      const { year, month, date } = getUrlParams();
      return `upsc_quiz_${year}_${month}_${date}`;
    }

    function saveToLocalStorage() {
      const storageKey = getStorageKey();
      const data = {
        answers: Array.from(session.answers.entries()),
        index: session.index,
        score: session.score,
        streak: session.streak,
        timestamp: new Date().toISOString(),
        questionsCount: session.data.length
      };
      localStorage.setItem(storageKey, JSON.stringify(data));
      showSavedBadge();
    }

    function loadFromLocalStorage() {
      const storageKey = getStorageKey();
      const saved = localStorage.getItem(storageKey);
      if (!saved) return false;
      
      try {
        const data = JSON.parse(saved);
        session.answers = new Map(data.answers);
        session.index = data.index || 0;
        session.score = data.score || 0;
        session.streak = data.streak || 0;
        return true;
      } catch (e) {
        console.error('Failed to load saved data:', e);
        return false;
      }
    }

    function clearLocalStorage() {
      const storageKey = getStorageKey();
      if (confirm('⚠️ Delete all saved progress for this quiz?\n\nThis action cannot be undone!')) {
        localStorage.removeItem(storageKey);
        showDeleteConfirmation();
        setTimeout(() => window.location.reload(), 1500);
      }
    }

    function showSavedBadge() {
      const badge = document.createElement('div');
      badge.className = 'saved-badge';
      badge.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Progress Saved!';
      document.body.appendChild(badge);
      setTimeout(() => badge.remove(), 2000);
    }

    function showDeleteConfirmation() {
      const conf = document.createElement('div');
      conf.className = 'saved-badge delete-confirmation';
      conf.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
      conf.innerHTML = '<i class="fas fa-trash mr-2"></i>Data Deleted!';
      document.body.appendChild(conf);
      setTimeout(() => conf.remove(), 2000);
    }

    // =========================
    // Session state with persistence
    // =========================
    const session = {
      data: [],            // questions
      index: 0,            // current index
      answers: new Map(),  // id -> { selectedText, correct, correctText }
      score: 0,            // correct answers count
      streak: 0,           // consecutive correct answers
      maxStreak: 0         // highest streak in session
    };

    // =========================
    // Elements
    // =========================
    const container = document.getElementById('question-carousel');
    const modal = document.getElementById('solution-modal');
    const modalClose = document.getElementById('modal-close');
    const modalContent = document.getElementById('modal-content');

    const dateInfo = document.getElementById('date-info');
    const loader = document.getElementById('loader');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const counter = document.getElementById('counter');
    const progressBar = document.getElementById('progress-bar');
    const scoreDisplay = document.getElementById('score-display');
    const totalQuestionsDisplay = document.getElementById('total-questions');
    const accuracyDisplay = document.getElementById('accuracy-display');
    const streakIndicator = document.getElementById('streak-indicator');
    const streakCount = document.getElementById('streak-count');

    // Wiki elements
    const wikiOverlay = document.getElementById('overlay');
    const wikiPopup = document.getElementById('wikiPopup');
    const wikiTitleEl = document.getElementById('wikiTitle');
    const wikiContentEl = document.getElementById('wikiContent');
    const wikiAttribEl = document.getElementById('wikiAttribution');

    // =========================
    // Helpers
    // =========================
    function getUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        year: urlParams.get('year'),
        month: urlParams.get('month'),
        date: urlParams.get('date')
      };
    }

    function sanitizeHTML(html) {
      return DOMPurify.sanitize(html, {
        ALLOWED_ATTR: ['href','target','rel','src','alt','title']
      });
    }

    function renderMarkdown(md) {
      const raw = marked.parse(md || '');
      // Add [[Wiki Term]] enrichment before sanitization
      const enriched = raw.replace(/\[\[(.*?)\]\]/g, (match, title) => {
        return `<span class="wiki-keyword" onclick="showWikiContent('${title.replace(/'/g, "\\'")}')">${title}</span>`;
      });
      return sanitizeHTML(enriched);
    }

    function updateHeader() {
      const { year, month, date } = getUrlParams();
      const dateText = `📅 Practice Date: ${date || '—'} ${month || ''}, ${year || ''}`.trim();
      dateInfo.textContent = dateText;
      
      // Update mobile date info
      const mobileDateInfo = document.getElementById('date-info-mobile');
      if (mobileDateInfo) {
        mobileDateInfo.textContent = dateText;
      }

      // Update navbar with practice date
      const navbarTitle = document.getElementById('navbar-date-display');
      const navbarSubtitle = document.getElementById('navbar-date-subtitle');
      if (navbarTitle && navbarSubtitle) {
        navbarTitle.textContent = `${date || '—'} ${month || ''}, ${year || ''}`.trim();
        navbarSubtitle.textContent = 'Practice Quiz';
      }
    }

    function updateProgressUI() {
      const total = session.data.length;
      counter.textContent = `${Math.min(session.index + 1, total)} / ${total}`;
      const attempted = Array.from(session.answers.values()).filter(v => v.selectedText != null).length;
      const pct = total ? Math.round((attempted / total) * 100) : 0;
      progressBar.style.width = pct + '%';
      
      // Update score display
      scoreDisplay.textContent = session.score;
      totalQuestionsDisplay.textContent = total;
      
      // Update accuracy
      const accuracy = attempted > 0 ? Math.round((session.score / attempted) * 100) : 0;
      accuracyDisplay.textContent = accuracy + '%';
      
      // Update streak display
      if (session.streak >= 3) {
        streakIndicator.classList.remove('hidden');
        streakCount.textContent = session.streak;
        streakIndicator.classList.add('streak-indicator');
        setTimeout(() => streakIndicator.classList.remove('streak-indicator'), 600);
      } else {
        streakIndicator.classList.add('hidden');
      }
      
      // Celebrate progress milestones
      if (pct === 25 || pct === 50 || pct === 75 || pct === 100) {
        progressBar.classList.add('progress-celebrate');
        setTimeout(() => progressBar.classList.remove('progress-celebrate'), 1000);
      }

      prevBtn.disabled = session.index <= 0;
      nextBtn.disabled = session.index >= total - 1 || total === 0;
    }

    function applyPressed(el) {
      el.classList.add('pressed');
      setTimeout(() => el.classList.remove('pressed'), 120);
    }

    function createConfetti() {
      const burst = document.createElement('div');
      burst.className = 'confetti-burst';
      
      const colors = ['#f59e0b', '#f97316', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'];
      
      for (let i = 0; i < 30; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 - 50 + 'px';
        confetti.style.animationDelay = Math.random() * 0.3 + 's';
        confetti.style.animationDuration = Math.random() * 1 + 1 + 's';
        burst.appendChild(confetti);
      }
      
      document.body.appendChild(burst);
      setTimeout(() => burst.remove(), 2000);
    }

    // =========================
    // Render Question
    // =========================
    function renderQuestion(q, idx) {
      const card = document.createElement('div');
      card.className = 'bg-white dark:bg-gray-800 shadow-soft rounded-2xl p-6 md:p-7 card-enter border border-amber-100 dark:border-amber-900/30';

      // Tags
      if (q.tags) {
        const tagWrap = document.createElement('div');
        tagWrap.className = 'flex flex-wrap gap-2 mb-4';
        const tagColors = [
          ['bg-pink-100','text-pink-800'],['bg-purple-100','text-purple-800'],
          ['bg-green-100','text-green-800'],['bg-blue-100','text-blue-800'],
          ['bg-red-100','text-red-800'],['bg-yellow-100','text-yellow-800'],
          ['bg-indigo-100','text-indigo-800'],['bg-teal-100','text-teal-800'],
          ['bg-rose-100','text-rose-800'],['bg-orange-100','text-orange-800'],
        ];
        (q.tags.split(',').map(t=>t.trim())).forEach(tag => {
          const chip = document.createElement('span');
          const [bg, txt] = tagColors[Math.floor(Math.random()*tagColors.length)];
          chip.className = `${bg} ${txt} text-xs font-medium px-2.5 py-0.5 rounded-full`;
          chip.textContent = tag;
          tagWrap.appendChild(chip);
        });
        card.appendChild(tagWrap);
      }

      // Title
      const h = document.createElement('h3');
      h.className = 'text-lg font-semibold text-gray-800 dark:text-gray-100';
      h.textContent = `Q${idx + 1}. ${q.question}`;
      card.appendChild(h);

      // Statements
      if (Array.isArray(q.statements) && q.statements.length) {
        const list = document.createElement('ol');
        list.className = 'list-decimal pl-6 mt-3 space-y-1 text-[15px] text-gray-800 dark:text-gray-200';
        q.statements.forEach(s => {
          const li = document.createElement('li');
          li.textContent = s;
          list.appendChild(li);
        });
        card.appendChild(list);
      }

      // Options
      const optionsDiv = document.createElement('div');
      optionsDiv.className = 'mt-4 space-y-3';
      let answeredObj = session.answers.get(idx) || { selectedText: null, correct: null, correctText: q.correct_option };

      q.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.textContent = opt;
        btn.className = 'option-btn block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 border-amber-200 dark:border-amber-700 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-gray-700 dark:to-gray-600 font-medium';
        optionsDiv.appendChild(btn);

        if (answeredObj.selectedText != null) {
          btn.disabled = true;
          if (opt === answeredObj.selectedText && answeredObj.correct) {
            btn.className = 'option-btn option-correct block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold';
          } else if (opt === answeredObj.selectedText && !answeredObj.correct) {
            btn.className = 'option-btn option-wrong block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold';
          } else if (opt === answeredObj.correctText) {
            btn.className = 'option-btn option-reveal block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-medium';
          }
        }

        btn.onclick = () => {
          if (session.answers.get(idx)?.selectedText != null) return;

          const isCorrect = opt === q.correct_option;
          
          // Update score and streak
          if (isCorrect) {
            session.score++;
            session.streak++;
            session.maxStreak = Math.max(session.maxStreak, session.streak);
          } else {
            session.streak = 0;
          }
          
          answeredObj = { selectedText: opt, correct: isCorrect, correctText: q.correct_option };
          session.answers.set(idx, answeredObj);

          // Animate and colorize all options
          Array.from(optionsDiv.children).forEach(b => {
            b.disabled = true;
            const text = b.textContent;
            if (text === opt && isCorrect) {
              b.className = 'option-btn option-correct block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold';
              createConfetti();
            } else if (text === opt && !isCorrect) {
              b.className = 'option-btn option-wrong block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold';
            } else if (text === q.correct_option) {
              b.className = 'option-btn option-reveal block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-medium';
            }
          });

          // Feedback
          feedback.textContent = isCorrect ? '✅ Correct! Well done!' : `❌ Wrong! Correct Answer: ${q.correct_option}`;
          feedback.className = isCorrect ? 'text-green-700 dark:text-green-400 mt-3 text-base font-bold' : 'text-red-700 dark:text-red-400 mt-3 text-base font-bold';
          expBtn.classList.remove('hidden');

          updateProgressUI();
          saveToLocalStorage();
        };
      });

      card.appendChild(optionsDiv);

      // Feedback + explanation
      const feedback = document.createElement('p');
      if (answeredObj.selectedText != null) {
        feedback.textContent = answeredObj.correct ? '✅ Correct! Well done!' : `❌ Wrong! Correct Answer: ${q.correct_option}`;
        feedback.className = answeredObj.correct ? 'text-green-700 dark:text-green-400 mt-3 text-base font-bold' : 'text-red-700 dark:text-red-400 mt-3 text-base font-bold';
      } else {
        feedback.className = 'mt-3 text-sm text-gray-500 dark:text-gray-400 italic';
        feedback.textContent = '💡 Select an option to check your answer.';
      }
      card.appendChild(feedback);

      const expBtn = document.createElement('button');
      expBtn.className = 'mt-4 inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white px-5 py-3 text-sm font-semibold shadow-lg transition-all hover:scale-105 ' + (answeredObj.selectedText != null ? '' : 'hidden');
      expBtn.innerHTML = '<i class="fa-solid fa-lightbulb"></i><span>View Explanation</span>';
      expBtn.addEventListener('click', () => openModal(renderMarkdown(q.explanation || 'No explanation provided.')));
      card.appendChild(expBtn);

      return card;
    }

    function renderPage() {
      container.innerHTML = '';
      if (!session.data.length) {
        container.innerHTML = `<p class="text-center text-red-600 mt-6">⚠️ No questions found.</p>`;
        return;
      }
      const card = renderQuestion(session.data[session.index], session.index);
      container.appendChild(card);
      updateProgressUI();
      updateQuestionGrid();
    }

    function updateQuestionGrid() {
      // Update desktop grid
      const grid = document.getElementById('question-grid');
      if (grid) {
        grid.innerHTML = '';
        session.data.forEach((q, idx) => {
          const btn = createQuestionButton(idx);
          grid.appendChild(btn);
        });
      }

      // Update mobile grid
      const mobileGrid = document.getElementById('mobile-question-grid');
      if (mobileGrid) {
        mobileGrid.innerHTML = '';
        session.data.forEach((q, idx) => {
          const btn = createQuestionButton(idx, true);
          mobileGrid.appendChild(btn);
        });
      }

      // Update mobile stats
      document.getElementById('mobile-score-display').textContent = session.score;
      document.getElementById('mobile-total-questions').textContent = session.data.length;
      
      const attempted = Array.from(session.answers.values()).filter(v => v.selectedText != null).length;
      const accuracy = attempted > 0 ? Math.round((session.score / attempted) * 100) : 0;
      document.getElementById('mobile-accuracy-display').textContent = accuracy + '%';
      
      const total = session.data.length;
      const pct = total ? Math.round((attempted / total) * 100) : 0;
      document.getElementById('mobile-progress-bar').style.width = pct + '%';
    }

    function createQuestionButton(idx, isMobile = false) {
      const btn = document.createElement('button');
      btn.className = 'question-number unattempted';
      btn.textContent = idx + 1;
      btn.title = `Question ${idx + 1}`;
      
      // Apply status
      const answer = session.answers.get(idx);
      if (answer?.selectedText != null) {
        btn.className = answer.correct ? 'question-number correct' : 'question-number wrong';
      }
      
      // Highlight current question
      if (idx === session.index) {
        btn.classList.add('active');
      }
      
      // Click to jump to question
      btn.addEventListener('click', () => {
        session.index = idx;
        renderPage();
        if (isMobile) {
          closeMobileSheet();
        }
      });
      
      return btn;
    }

    function openMobileSheet() {
      const sheet = document.getElementById('mobile-bottom-sheet');
      const overlay = document.getElementById('mobile-bottom-sheet-overlay');
      
      overlay.classList.remove('hidden');
      overlay.classList.add('overlay-open');
      
      setTimeout(() => {
        sheet.classList.add('sheet-open');
      }, 10);
      
      document.body.style.overflow = 'hidden';
    }

    function closeMobileSheet() {
      const sheet = document.getElementById('mobile-bottom-sheet');
      const overlay = document.getElementById('mobile-bottom-sheet-overlay');
      
      sheet.classList.remove('sheet-open');
      overlay.classList.remove('overlay-open');
      
      setTimeout(() => {
        overlay.classList.add('hidden');
      }, 300);
      
      document.body.style.overflow = '';
    }

    window.closeMobileSheet = closeMobileSheet;

    // =========================
    // Modal controls
    // =========================
    function openModal(html) {
      modalContent.innerHTML = html;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.classList.add('modal-open');
      modal.setAttribute('aria-hidden', 'false');
      document.getElementById('modal-close').focus();
    }
    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.classList.remove('modal-open');
      modal.setAttribute('aria-hidden', 'true');
    }
    document.getElementById('modal-close').addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal(); });

    // =========================
    // Navigation
    // =========================
    prevBtn.addEventListener('click', () => { 
      applyPressed(prevBtn); 
      if (session.index > 0) { 
        session.index--; 
        renderPage(); 
      } 
    });
    
    nextBtn.addEventListener('click', () => { 
      applyPressed(nextBtn); 
      if (session.index < session.data.length - 1) { 
        session.index++; 
        renderPage(); 
      } 
    });

    // Jump buttons
    document.getElementById('jump-first')?.addEventListener('click', () => {
      if (session.index !== 0) {
        session.index = 0;
        renderPage();
      }
    });

    document.getElementById('jump-last')?.addEventListener('click', () => {
      const lastIndex = session.data.length - 1;
      if (session.index !== lastIndex && lastIndex >= 0) {
        session.index = lastIndex;
        renderPage();
      }
    });

    // Mobile bottom sheet toggle
    document.getElementById('toggle-nav')?.addEventListener('click', openMobileSheet);
    document.getElementById('mobile-menu-fab')?.addEventListener('click', openMobileSheet);
    
    // Mobile action buttons
    document.getElementById('mobile-clear-data-btn')?.addEventListener('click', () => {
      clearLocalStorage();
    });
    
    document.getElementById('mobile-reset-session')?.addEventListener('click', () => {
      if (!confirm('🔄 Reset current session?\n\nAnswers will be cleared but saved data will remain in storage.')) return;
      session.answers.clear();
      session.index = 0;
      session.score = 0;
      session.streak = 0;
      session.maxStreak = 0;
      renderPage();
      saveToLocalStorage();
      closeMobileSheet();
    });

    // Swipe
    let touchStartX = 0;
    container.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, { passive: true });
    container.addEventListener('touchend', e => {
      const diffX = e.changedTouches[0].clientX - touchStartX;
      if (diffX > 50 && session.index > 0) { session.index--; renderPage(); }
      else if (diffX < -50 && session.index < session.data.length - 1) { session.index++; renderPage(); }
    }, { passive: true });

    // Keyboard
    window.addEventListener('keydown', (e) => {
      if (!modal.classList.contains('hidden')) return;
      if (e.key === 'ArrowLeft') { if (session.index > 0) { session.index--; renderPage(); } }
      if (e.key === 'ArrowRight') { if (session.index < session.data.length - 1) { session.index++; renderPage(); } }
    });

    // Reset session
    document.getElementById('reset-session').addEventListener('click', () => {
      applyPressed(document.getElementById('reset-session'));
      if (!confirm('🔄 Reset current session?\n\nAnswers will be cleared but saved data will remain in storage.')) return;
      session.answers.clear();
      session.index = 0;
      session.score = 0;
      session.streak = 0;
      session.maxStreak = 0;
      renderPage();
      saveToLocalStorage();
    });

    // Clear data button
    document.getElementById('clear-data-btn').addEventListener('click', () => {
      applyPressed(document.getElementById('clear-data-btn'));
      clearLocalStorage();
    });

    // =========================
    // Wiki integration (works cross-origin via origin=*)
    // =========================
    async function showWikiContent(title) {
      const apiUrl = `https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&titles=${encodeURIComponent(title)}&format=json&origin=*`;

      // Show sheet + loading state
      wikiTitleEl.textContent = 'Loading…';
      wikiContentEl.textContent = 'Please wait…';
      wikiAttribEl.textContent = '';
      wikiOverlay.style.display = 'block';
      wikiPopup.style.display = 'block';

      try {
        const res = await fetch(apiUrl, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('Network error');
        const data = await res.json();
        const page = Object.values(data?.query?.pages || {})[0];

        if (!page || page.missing === '' || !page.extract) {
          wikiTitleEl.textContent = title;
          wikiContentEl.textContent = 'No content found.';
          wikiAttribEl.innerHTML = '';
          return;
        }

        wikiTitleEl.textContent = page.title || title;
        wikiContentEl.textContent = page.extract;
        wikiAttribEl.innerHTML = `Source: Wikipedia — <a href="https://en.wikipedia.org/wiki/${encodeURIComponent(page.title)}" target="_blank" rel="noopener noreferrer" class="text-blue-700 underline">open full article</a>`;
      } catch (err) {
        console.error(err);
        wikiTitleEl.textContent = 'Error';
        wikiContentEl.textContent = 'Failed to load content.';
        wikiAttribEl.textContent = '';
      }
    }
    window.showWikiContent = showWikiContent; // make available for onclick

    function closeWikiPopup() {
      wikiOverlay.style.display = 'none';
      wikiPopup.style.display = 'none';
    }
    window.closeWikiPopup = closeWikiPopup;

    // =========================
    // Fullscreen Management
    // =========================
    function enterFullscreen() {
      const elem = document.documentElement;
      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
      } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
      }
      
      // Show exit button in fullscreen
      const exitBtn = document.getElementById('exit-fullscreen-btn');
      if (exitBtn) exitBtn.classList.remove('hidden');
    }

    function exitFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
      
      // Hide exit button
      const exitBtn = document.getElementById('exit-fullscreen-btn');
      if (exitBtn) exitBtn.classList.add('hidden');
    }

    function startQuiz() {
      // Hide fullscreen prompt
      document.getElementById('fullscreen-prompt').classList.add('hidden');
      
      // Show quiz container
      document.getElementById('quiz-container').classList.remove('hidden');
      
      // Show mobile FAB
      document.getElementById('mobile-menu-fab')?.classList.remove('hidden');
      
      // Show loader
      document.getElementById('loader').classList.remove('hidden');
      
      // Load questions
      loadQuestions();
    }

    // Fullscreen prompt handlers
    document.getElementById('enter-fullscreen')?.addEventListener('click', () => {
      enterFullscreen();
      startQuiz();
    });

    document.getElementById('skip-fullscreen')?.addEventListener('click', () => {
      startQuiz();
    });

    document.getElementById('exit-fullscreen-btn')?.addEventListener('click', () => {
      exitFullscreen();
    });

    // Handle fullscreen change
    document.addEventListener('fullscreenchange', () => {
      const exitBtn = document.getElementById('exit-fullscreen-btn');
      if (exitBtn) {
        if (document.fullscreenElement) {
          exitBtn.classList.remove('hidden');
        } else {
          exitBtn.classList.add('hidden');
        }
      }
    });

    // =========================
    // Load Questions
    // =========================
    async function loadQuestions() {
      updateHeader();
      const { year, month, date } = getUrlParams();

      try {
        const res = await fetch(`./question/practice/${year}/${month}/${date}.json`, { cache: 'no-store' });
        const data = await res.json();

        // Normalize minimal
        session.data = (data || []).map((q) => ({
          ...q,
          question: String(q.question || '').trim(),
          options: Array.isArray(q.options) ? q.options.slice() : [],
          correct_option: q.correct_option
        }));

        // Load saved progress from localStorage
        const hasProgress = loadFromLocalStorage();
        
        loader.classList.add('hidden');
        
        if (hasProgress) {
          // Show restoration notification
          const notification = document.createElement('div');
          notification.className = 'saved-badge';
          notification.innerHTML = '<i class="fas fa-history mr-2"></i>Progress Restored!';
          document.body.appendChild(notification);
          setTimeout(() => notification.remove(), 3000);
        }
        
        renderPage();
      } catch (error) {
        console.error('Error loading questions:', error);
        loader.classList.add('hidden');
        container.innerHTML = `<p class='text-red-600 dark:text-red-400 text-center mt-6'>❌ Questions Coming Soon or failed to load.</p>`;
      }
    }

    // On page load, show fullscreen prompt instead of loading immediately
    document.addEventListener('DOMContentLoaded', () => {
      // Show fullscreen prompt (quiz will load after user choice)
      document.getElementById('fullscreen-prompt').classList.remove('hidden');
    });
  </script>
    <script src="/upsc-notes/assets/ui.js"></script>
</body>
</html>
