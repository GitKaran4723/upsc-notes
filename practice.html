<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>UPSC Practice Questions — Daily Sets</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#fef3e2', 100: '#fde8c4', 200: '#fbd18a', 300: '#f9ba4f',
              400: '#f7a320', 500: '#f59e0b', 600: '#d97706', 700: '#b45309',
              800: '#92400e', 900: '#78350f'
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in',
            'float': 'float 3s ease-in-out infinite',
            'glow': 'glow 2s ease-in-out infinite alternate',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            float: { '0%, 100%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-10px)' } },
            glow: { '0%': { boxShadow: '0 0 5px rgba(245, 158, 11, 0.5)' }, '100%': { boxShadow: '0 0 20px rgba(245, 158, 11, 0.8)' } }
          },
          boxShadow: {
            soft: '0 12px 32px rgba(0,0,0,.08)',
            ring: '0 0 0 8px rgba(251, 191, 36, .15)'
          }
        }
      }
    }
  </script>

  <!-- Icons -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <link rel="stylesheet" href="/upsc-notes/assets/ui.css">

  <style>
    html { scroll-behavior: smooth; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .glass-effect { 
      background: rgba(255,255,255,0.1); 
      backdrop-filter: blur(10px); 
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .dark .glass-effect {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .gradient-text {
      background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .pressed { transform: translateY(1px); }
    .skeleton {
      background: linear-gradient(90deg,#eee, #f5f5f5, #eee);
      background-size: 200% 100%; animation: shimmer 1.2s ease-in-out infinite;
    }
    .dark .skeleton {
      background: linear-gradient(90deg, #374151, #4b5563, #374151);
      background-size: 200% 100%;
    }
    @keyframes shimmer { 0%{background-position: 200% 0} 100%{background-position: -200% 0} }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-amber-50 via-white to-amber-100 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 text-gray-900 dark:text-gray-100 selection:bg-amber-200/60 dark:selection:bg-amber-700/60 transition-colors duration-200">

  <!-- Top bar -->
  <header class="sticky top-0 z-50 glass dark:bg-gray-800/90 border-b border-amber-200/70 dark:border-gray-700">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <span class="p-2 rounded-xl bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300">
          <i class="fa-solid fa-calendar-check"></i>
        </span>
        <div>
          <h1 class="text-lg sm:text-xl font-bold tracking-wide dark:text-white">
            UPSC CSE — Daily Practice Questions
          </h1>
          <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">Curated daily sets for Prelims 2026</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <a href="/upsc-notes/" class="hidden sm:inline text-sm text-gray-700 dark:text-gray-300 hover:text-amber-700 dark:hover:text-amber-500">Home</a>
        <a href="/upsc-notes/subjectpractice.html" class="hidden sm:inline text-sm text-gray-700 dark:text-gray-300 hover:text-amber-700 dark:hover:text-amber-500">Subjects</a>
        <a href="/upsc-notes/pyq.html" class="hidden sm:inline text-sm text-gray-700 dark:text-gray-300 hover:text-amber-700 dark:hover:text-amber-500">PYQs</a>
        <button id="themeToggle" class="rounded-lg border border-amber-300 dark:border-gray-600 bg-white dark:bg-gray-700 hover:bg-amber-50 dark:hover:bg-gray-600 px-3 py-2 text-sm text-gray-900 dark:text-gray-100">
          <i class="fa-solid fa-circle-half-stroke"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Hero / Overview -->
  <section class="px-4 pt-6 pb-4">
    <div class="max-w-6xl mx-auto">
      <div class="rounded-2xl bg-gradient-to-r from-amber-100 to-amber-50 dark:from-gray-800 dark:to-gray-700 border border-amber-200 dark:border-gray-600 p-5 md:p-6 shadow-soft">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
          <div>
            <h2 class="text-2xl font-semibold text-amber-800 dark:text-amber-300">Stay Practiced. Stay Ahead.</h2>
            <p class="mt-1 text-sm text-gray-700 dark:text-gray-300">
              Pick a date to start your session. Track consistency and revisit recent sets quickly.
            </p>
          </div>
          <div class="flex items-center gap-2">
            <button id="latestBtn"
                    class="inline-flex items-center gap-2 rounded-lg bg-gray-900 dark:bg-amber-600 text-white px-4 py-2 shadow-soft hover:opacity-90">
              <i class="fa-solid fa-bolt"></i><span>Jump to Latest</span>
            </button>
            <button id="clearSearch"
                    class="hidden md:inline-flex items-center gap-2 rounded-lg bg-white dark:bg-gray-700 border border-amber-300 dark:border-gray-600 px-4 py-2 text-sm text-gray-900 dark:text-gray-100 hover:bg-amber-50 dark:hover:bg-gray-600">
              <i class="fa-solid fa-eraser"></i><span>Clear Filters</span>
            </button>
          </div>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
            <i class="fa-solid fa-check-double text-emerald-600 dark:text-emerald-400"></i>
            Practice daily to build recall & speed.
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
            <i class="fa-regular fa-clock text-blue-600 dark:text-blue-400"></i>
            Short, focused sessions fit any schedule.
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
            <i class="fa-solid fa-rotate text-amber-700 dark:text-amber-400"></i>
            Revisit recent dates with one click.
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Toolbar -->
  <section class="px-4">
    <div class="max-w-6xl mx-auto">
      <div class="flex flex-col md:flex-row items-stretch md:items-center gap-3">
        <div class="flex-1 relative">
          <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-500 dark:text-gray-400"></i>
          <input id="search"
                 class="w-full pl-10 pr-3 py-2 rounded-xl border border-amber-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-400 dark:focus:ring-amber-500"
                 placeholder="Search month (e.g., June) or year (e.g., 2025)…"/>
        </div>
        <div class="flex items-center gap-2">
          <select id="yearSelect"
                  class="rounded-xl border border-amber-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400 dark:focus:ring-amber-500">
            <option value="all">All Years</option>
          </select>
          <select id="monthSelect"
                  class="rounded-xl border border-amber-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400 dark:focus:ring-amber-500">
            <option value="all">All Months</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <!-- Main content -->
  <section class="p-4">
    <div class="max-w-6xl mx-auto space-y-8">
      
      <!-- Subject Practice Section -->
      <div id="subject-practice-section">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200 flex items-center gap-2">
            <i class="fas fa-book text-blue-600 dark:text-blue-400"></i>
            Subject Practice
          </h3>
          <a href="/upsc-notes/subjectpractice.html" class="text-sm text-blue-600 dark:text-blue-400 hover:underline">View All →</a>
        </div>
        <div id="subjects-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3"></div>
      </div>

      <!-- Daily Practice by Date -->
      <div id="date-practice-section">
        <h3 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200 flex items-center gap-2">
          <i class="fas fa-calendar-days text-emerald-600 dark:text-emerald-400"></i>
          Daily Practice Sets
        </h3>

        <!-- Stats row -->
        <div id="statsRow" class="mb-4 hidden">
          <div class="flex flex-wrap items-center justify-center gap-2 text-xs text-gray-600 dark:text-gray-400">
            <span class="inline-flex items-center gap-1 bg-white dark:bg-gray-700 border border-amber-200 dark:border-gray-600 rounded-full px-3 py-1">
              <i class="fa-regular fa-calendar"></i> <span id="totalSets">0</span> total sets
            </span>
            <span class="inline-flex items-center gap-1 bg-white dark:bg-gray-700 border border-amber-200 dark:border-gray-600 rounded-full px-3 py-1">
              <i class="fa-regular fa-clock"></i> <span id="latestStamp">—</span> latest
            </span>
          </div>
        </div>

        <!-- Container -->
        <div id="practice-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

        <!-- Empty / error -->
        <div id="emptyState" class="hidden mt-8 text-center">
          <div class="mx-auto w-16 h-16 rounded-2xl bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300 flex items-center justify-center">
            <i class="fa-regular fa-face-frown text-2xl"></i>
          </div>
          <p class="mt-3 text-gray-700 dark:text-gray-300 font-medium">No matching dates found.</p>
          <p class="text-sm text-gray-500 dark:text-gray-400">Try clearing filters or search for another month/year.</p>
          <button id="resetEmpty"
                  class="mt-3 inline-flex items-center gap-2 rounded-lg bg-gray-900 dark:bg-amber-600 text-white px-4 py-2 shadow-soft hover:opacity-90">
            <i class="fa-solid fa-rotate"></i> Reset Filters
          </button>
        </div>

        <!-- Skeleton (initial) -->
        <div id="skeletonGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="rounded-xl border border-amber-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-5 shadow-soft skeleton h-28"></div>
          <div class="rounded-xl border border-amber-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-5 shadow-soft skeleton h-28"></div>
          <div class="rounded-xl border border-amber-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-5 shadow-soft skeleton h-28"></div>
        </div>
      </div>

    </div>
  </section>

  <!-- Footer quick tips -->
  <footer class="px-4 pb-10">
    <div class="max-w-6xl mx-auto">
      <div class="rounded-2xl bg-white dark:bg-gray-800 border border-amber-200 dark:border-gray-600 p-5 text-sm text-gray-700 dark:text-gray-300 shadow-soft">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
          <p class="flex items-center gap-2">
            <i class="fa-solid fa-lightbulb text-amber-600 dark:text-amber-400"></i>
            Tip: Use <kbd class="px-1.5 py-[2px] rounded border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700">/</kbd> to focus search. Arrow keys navigate dates inside a year card.
          </p>
          <button id="clearAll"
                  class="inline-flex items-center gap-2 rounded-lg bg-amber-600 dark:bg-amber-700 text-white px-4 py-2 hover:bg-amber-700 dark:hover:bg-amber-600">
            <i class="fa-solid fa-broom"></i> Clear Filters
          </button>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // -------------------------
    // Utilities & State
    // -------------------------
    const MONTHS = [
      'january','february','march','april','may','june',
      'july','august','september','october','november','december'
    ];

    const MONTH_MAP = {
      'jan': 0, 'january': 0,
      'feb': 1, 'february': 1,
      'mar': 2, 'march': 2,
      'apr': 3, 'april': 3,
      'may': 4,
      'jun': 5, 'june': 5,
      'jul': 6, 'july': 6,
      'aug': 7, 'august': 7,
      'sep': 8, 'september': 8,
      'oct': 9, 'october': 9,
      'nov': 10, 'november': 10,
      'dec': 11, 'december': 11
    };

    const $ = sel => document.querySelector(sel);
    const container = $('#practice-container');
    const skeletonGrid = $('#skeletonGrid');
    const emptyState = $('#emptyState');
    const totalSetsEl = $('#totalSets');
    const latestStampEl = $('#latestStamp');
    const statsRow = $('#statsRow');

    const yearSelect = $('#yearSelect');
    const monthSelect = $('#monthSelect');
    const searchInput = $('#search');

    const latestBtn = $('#latestBtn');
    const clearSearchBtn = $('#clearSearch');
    const clearAllBtn = $('#clearAll');
    const resetEmptyBtn = $('#resetEmpty');

    const themeToggle = $('#themeToggle');

    let META = {};          // original metadata
    let FILTERED = {};      // filtered metadata
    let LATEST = null;      // {year, month, date}

    // Subject colors mapping
    const SUBJECT_COLORS = {
      'Polity': { bg: 'from-blue-500 to-indigo-600', icon: 'fa-scale-balanced' },
      'History': { bg: 'from-amber-500 to-orange-600', icon: 'fa-landmark' },
      'Economy': { bg: 'from-green-500 to-emerald-600', icon: 'fa-chart-line' },
      'Geography': { bg: 'from-teal-500 to-cyan-600', icon: 'fa-earth-americas' },
      'Environment': { bg: 'from-lime-500 to-green-600', icon: 'fa-leaf' },
      'Science': { bg: 'from-purple-500 to-pink-600', icon: 'fa-flask' }
    };

    function toDateObj(year, month, date) {
      // Create a comparable Date for sorting (month name -> index)
      const monthKey = String(month).toLowerCase();
      const mi = MONTH_MAP[monthKey];
      return new Date(Number(year), mi !== undefined ? mi : 0, Number(date));
    }

    function monthTitle(m) {
      return m.charAt(0).toUpperCase() + m.slice(1);
    }

    function applyPressed(el) { el.classList.add('pressed'); setTimeout(()=>el.classList.remove('pressed'),120); }

    // -------------------------
    // Rendering
    // -------------------------
    function renderSubjects(subjects) {
      const container = document.getElementById('subjects-container');
      if (!subjects || !Object.keys(subjects).length) return;

      container.innerHTML = '';
      
      Object.keys(subjects).forEach(subject => {
        const topics = subjects[subject] || [];
        const colors = SUBJECT_COLORS[subject] || { bg: 'from-gray-500 to-gray-600', icon: 'fa-book' };
        
        const card = document.createElement('div');
        card.className = `rounded-xl bg-gradient-to-br ${colors.bg} p-4 text-white shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 cursor-pointer`;
        card.innerHTML = `
          <div class="flex flex-col items-center text-center gap-2">
            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
              <i class="fas ${colors.icon} text-2xl"></i>
            </div>
            <div>
              <div class="font-semibold text-sm">${subject}</div>
              <div class="text-xs opacity-90">${topics.length} concepts</div>
            </div>
          </div>
        `;
        
        // Click to expand and show concepts
        card.addEventListener('click', () => {
          showSubjectConcepts(subject, topics, colors);
        });
        
        container.appendChild(card);
      });
    }

    function showSubjectConcepts(subject, concepts, colors) {
      const container = document.getElementById('subjects-container');
      
      // Create expanded view with concepts
      const expandedCard = document.createElement('div');
      expandedCard.className = 'col-span-full rounded-xl bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 p-5 shadow-xl animate-fade-in';
      expandedCard.innerHTML = `
        <div class="flex items-start justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-gradient-to-br ${colors.bg} rounded-xl flex items-center justify-center">
              <i class="fas ${colors.icon} text-white text-xl"></i>
            </div>
            <div>
              <h4 class="text-xl font-bold text-gray-900 dark:text-white">${subject}</h4>
              <p class="text-sm text-gray-600 dark:text-gray-400">${concepts.length} concepts available</p>
            </div>
          </div>
          <button onclick="this.closest('.col-span-full').remove()" class="px-3 py-1 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 text-sm">
            <i class="fas fa-times"></i> Close
          </button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          ${concepts.map(concept => `
            <button onclick="window.location.href='/upsc-notes/question.html?subject=${encodeURIComponent(subject)}&concept=${encodeURIComponent(concept)}'" 
                    class="text-left px-4 py-3 rounded-lg bg-gradient-to-r ${colors.bg} text-white hover:opacity-90 transition-all shadow-md hover:shadow-lg">
              <div class="flex items-center gap-2">
                <i class="fas fa-play-circle"></i>
                <span class="font-medium">${concept.replace(/_/g, ' ')}</span>
              </div>
            </button>
          `).join('')}
        </div>
      `;
      
      // Insert after the subjects container
      container.parentElement.insertBefore(expandedCard, container.nextSibling);
      
      // Scroll to the expanded card
      expandedCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function renderMeta(meta) {
      container.innerHTML = '';
      emptyState.classList.add('hidden');

      const years = Object.keys(meta).sort((a, b) => b - a);
      if (!years.length) {
        emptyState.classList.remove('hidden');
        return;
      }

      let totalSets = 0;
      let latestDate = null;

      years.forEach(year => {
        const months = Object.keys(meta[year] || {});
        if (!months.length) return;

        // Year card
        const card = document.createElement('section');
        card.className = 'rounded-2xl bg-white dark:bg-gray-800 border border-amber-200 dark:border-gray-700 p-4 md:p-5 shadow-soft';

        // Header with toggle
        const hdr = document.createElement('div');
        hdr.className = 'flex items-center justify-between gap-3';
        hdr.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-xl bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300 font-bold">${String(year).slice(-2)}</span>
            <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Year ${year}</h4>
            <span class="ml-2 text-xs text-gray-600 dark:text-gray-400">(${Object.values(meta[year]).reduce((a,b)=>a+b.length,0)} sets)</span>
          </div>
          <button class="toggle-btn inline-flex items-center gap-2 rounded-lg bg-gray-900 dark:bg-amber-600 text-white px-3 py-2 text-sm hover:opacity-90">
            <i class="fa-solid fa-chevron-down"></i><span class="hidden sm:inline">Expand</span>
          </button>
        `;
        card.appendChild(hdr);

        // Body
        const body = document.createElement('div');
        body.className = 'mt-4 space-y-5 hidden';

        // Month blocks (sorted desc by date)
        const mSorted = months.sort((a, b) => {
          const da = toDateObj(year, a, 1);
          const db = toDateObj(year, b, 1);
          return db - da;
        });

        mSorted.forEach(month => {
          const dates = (meta[year][month] || []).sort((a,b)=>Number(b)-Number(a));
          if (!dates.length) return;

          // Track latest
          dates.forEach(d => {
            totalSets++;
            const dObj = toDateObj(year, month, d);
            if (!latestDate || dObj > latestDate) {
              latestDate = dObj;
              LATEST = { year, month, date: d };
            }
          });

          const wrap = document.createElement('div');

          wrap.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <h5 class="text-[15px] font-semibold text-amber-800 dark:text-amber-300">${monthTitle(month)}</h5>
              <span class="text-xs text-gray-500 dark:text-gray-400">${dates.length} set${dates.length>1?'s':''}</span>
            </div>
          `;

          const grid = document.createElement('div');
          grid.className = 'flex flex-wrap gap-2';

          dates.forEach(d => {
            const btn = document.createElement('a');
            btn.href = `/upsc-notes/question.html?year=${year}&month=${month}&date=${d}`;
            btn.className = 'date-btn inline-flex items-center justify-center min-w-[3rem] px-3 py-2 rounded-lg border border-amber-300 dark:border-amber-600 bg-amber-50 dark:bg-amber-900/30 hover:bg-amber-100 dark:hover:bg-amber-800/50 text-gray-900 dark:text-amber-100 font-semibold text-sm focus:outline-none focus:ring-2 focus:ring-amber-400 dark:focus:ring-amber-500 transition-colors';
            btn.textContent = d;
            btn.setAttribute('title', `${monthTitle(month)} ${d}, ${year}`);
            btn.addEventListener('keydown', (e) => {
              // Arrow navigation within grid
              if (e.key === 'ArrowRight') { e.preventDefault(); (btn.nextElementSibling || grid.firstElementChild).focus(); }
              if (e.key === 'ArrowLeft') { e.preventDefault(); (btn.previousElementSibling || grid.lastElementChild).focus(); }
            });
            grid.appendChild(btn);
          });

          wrap.appendChild(grid);
          body.appendChild(wrap);
        });

        card.appendChild(body);

        // Toggle
        hdr.querySelector('.toggle-btn').addEventListener('click', (e) => {
          applyPressed(e.currentTarget);
          body.classList.toggle('hidden');
          e.currentTarget.querySelector('i').classList.toggle('rotate-180');
          e.currentTarget.querySelector('span')?.classList.toggle('hidden');
        });

        container.appendChild(card);
      });

      // Stats
      totalSetsEl.textContent = totalSets;
      latestStampEl.textContent = LATEST
        ? `${monthTitle(LATEST.month)} ${LATEST.date}, ${LATEST.year}`
        : '—';
      statsRow.classList.remove('hidden');
    }

    // -------------------------
    // Filtering
    // -------------------------
    function applyFilters() {
      const q = (searchInput.value || '').trim().toLowerCase();
      const yFilter = yearSelect.value;
      const mFilter = monthSelect.value;

      const res = {};
      const years = Object.keys(META);

      years.forEach(year => {
        if (yFilter !== 'all' && String(year) !== yFilter) return;

        const months = Object.keys(META[year]);
        months.forEach(month => {
          if (mFilter !== 'all' && month !== mFilter) return;

          const hitsYear = q && String(year).includes(q);
          const hitsMonth = q && month.includes(q);

          // If search query exists, include only if any part matches
          if (q && !(hitsYear || hitsMonth)) return;

          const dates = META[year][month];
          if (!dates || !dates.length) return;

          if (!res[year]) res[year] = {};
          res[year][month] = dates.slice();
        });
      });

      FILTERED = res;
      renderMeta(FILTERED);

      // If nothing found
      if (!Object.keys(FILTERED).length) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
      }
    }

    function resetFilters() {
      searchInput.value = '';
      yearSelect.value = 'all';
      monthSelect.value = 'all';
      FILTERED = structuredClone(META);
      renderMeta(FILTERED);
    }

    // -------------------------
    // Data Load
    // -------------------------
    async function loadPracticeDates() {
      try {
        const response = await fetch('./question/practice/metadata.json', { cache: 'no-store' });
        const metadata = await response.json();

        // Separate subjects from date-based practice
        const { Subjects, ...dateBased } = metadata;

        // Render subjects section
        if (Subjects) {
          renderSubjects(Subjects);
        }

        // Handle date-based practice (includes current affairs by year/month/date)
        META = dateBased || {};
        FILTERED = structuredClone(META);

        // Populate selects
        const years = Object.keys(META).sort((a,b)=>b-a);
        years.forEach(y => {
          const opt = document.createElement('option');
          opt.value = y; opt.textContent = y;
          yearSelect.appendChild(opt);
        });

        const monthSet = new Set();
        years.forEach(y => Object.keys(META[y]).forEach(m => monthSet.add(m)));
        Array.from(monthSet).sort((a,b)=>MONTHS.indexOf(a)-MONTHS.indexOf(b)).forEach(m => {
          const opt = document.createElement('option');
          opt.value = m; opt.textContent = monthTitle(m);
          monthSelect.appendChild(opt);
        });

        // Render
        skeletonGrid.classList.add('hidden');
        renderMeta(FILTERED);
      } catch (err) {
        console.error('Error loading practice metadata:', err);
        skeletonGrid.classList.add('hidden');
        container.innerHTML = "<p class='text-red-600 text-center'>⚠️ Failed to load practice dates. Please try again later.</p>";
      }
    }

    // -------------------------
    // Events
    // -------------------------
    document.addEventListener('DOMContentLoaded', loadPracticeDates);

    // Search focus with '/' key
    window.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== searchInput) {
        e.preventDefault();
        searchInput.focus();
      }
    });

    searchInput.addEventListener('input', applyFilters);
    yearSelect.addEventListener('change', applyFilters);
    monthSelect.addEventListener('change', applyFilters);

    clearSearchBtn.addEventListener('click', () => { applyPressed(clearSearchBtn); resetFilters(); });
    clearAllBtn.addEventListener('click', () => { applyPressed(clearAllBtn); resetFilters(); });
    resetEmptyBtn.addEventListener('click', () => { applyPressed(resetEmptyBtn); resetFilters(); });

    latestBtn.addEventListener('click', () => {
      applyPressed(latestBtn);
      if (!LATEST) return;
      window.location.href = `/upsc-notes/question.html?year=${LATEST.year}&month=${LATEST.month}&date=${LATEST.date}`;
    });

    // Migrate legacy theme key to centralized key
    try {
      const legacy = localStorage.getItem('theme');
      if (legacy && !localStorage.getItem('upsc_theme')) localStorage.setItem('upsc_theme', legacy);
    } catch (e) {}

    // Theme toggle (use shared window.upscUI when available)
    themeToggle.addEventListener('click', () => {
      applyPressed(themeToggle);
      if (window.upscUI && typeof window.upscUI.toggleTheme === 'function') {
        window.upscUI.toggleTheme();
      } else {
        document.documentElement.classList.toggle('dark');
        try { localStorage.setItem('upsc_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); } catch(e){}
      }
    });

    // If shared theme is saved, ui.js will set it; else fallback to legacy check
    if (!localStorage.getItem('upsc_theme') && (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches))) {
      document.documentElement.classList.add('dark');
      try { localStorage.setItem('upsc_theme', 'dark'); } catch(e){}
    }
  </script>
  <script src="/upsc-notes/assets/ui.js"></script>
</body>
</html>
