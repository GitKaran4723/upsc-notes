<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UPSC Subject Practice ‚Äî  Immersive Quiz Mode</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          animation: {
            'float': 'float 6s ease-in-out infinite',
            'glow': 'glow 2s ease-in-out infinite alternate',
          }
        }
      }
    }
  </script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#fef3e2', 100: '#fde7c5', 200: '#fbcf8b', 300: '#f9b751',
              400: '#f7a027', 500: '#f59e0b', 600: '#d97706', 700: '#b45309',
              800: '#92400e', 900: '#78350f'
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'float': 'float 3s ease-in-out infinite',
            'glow': 'glow 2s ease-in-out infinite alternate'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            },
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-20px)' }
            },
            glow: {
              '0%': { boxShadow: '0 0 5px rgba(245, 158, 11, 0.5)' },
              '100%': { boxShadow: '0 0 20px rgba(245, 158, 11, 0.8)' }
            }
          },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,0.08)' }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <style>
    html { scroll-behavior: smooth; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .glass-effect { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    .dark .glass-effect { background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); }
    .gradient-text { background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .pressed { transform: translateY(1px); }
    body.modal-open { overflow: hidden; }
    
    /* SUPERB ANIMATIONS */
    .card-enter { animation: card-enter 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes card-enter {
      0% { opacity: 0; transform: scale(0.8) rotateX(-15deg) translateY(50px); }
      100% { opacity: 1; transform: scale(1) rotateX(0) translateY(0); }
    }

    .option-btn { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); transform-style: preserve-3d; position: relative; overflow: hidden; }
    .option-btn::before { content: ''; position: absolute; inset: 0; background: linear-gradient(120deg, transparent, rgba(255,255,255,0.3), transparent); transform: translateX(-100%); transition: transform 0.6s; }
    .option-btn:hover::before { transform: translateX(100%); }
    .option-btn:hover:not(:disabled) { transform: translateY(-4px) scale(1.02); box-shadow: 0 12px 24px rgba(245, 158, 11, 0.3); }
    .option-btn:active:not(:disabled) { transform: translateY(-2px) scale(0.98); }

    .option-correct { animation: correct-bounce 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important; color: white !important; border-color: #059669 !important; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4); }
    .option-wrong { animation: wrong-shake 0.6s cubic-bezier(0.36, 0.07, 0.19, 0.97); background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important; color: white !important; border-color: #dc2626 !important; box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4); }
    .option-reveal { animation: reveal-glow 0.8s ease-out; background: linear-gradient(135deg, #6ee7b7 0%, #34d399 100%) !important; border-color: #10b981 !important; }

    @keyframes correct-bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-20px); } 60% { transform: translateY(-10px); } }
    @keyframes wrong-shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); } 20%, 40%, 60%, 80% { transform: translateX(8px); } }
    @keyframes reveal-glow { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.8); } 50% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

    .confetti-burst { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 9999; }
    .confetti { position: absolute; width: 10px; height: 10px; background: #f59e0b; animation: confetti-fall 1.5s ease-out forwards; }
    @keyframes confetti-fall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(300px) rotate(720deg); opacity: 0; } }

    .streak-indicator { animation: streak-pulse 0.6s ease-out; }
    @keyframes streak-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

    .progress-celebrate { animation: progress-shine 1s ease-in-out; }
    @keyframes progress-shine { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.5) drop-shadow(0 0 12px rgba(245, 158, 11, 0.8)); } }

    .saved-badge { position: fixed; top: 100px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4); animation: badge-slide-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 9999; }
    @keyframes badge-slide-in { 0% { transform: translateX(400px); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }

    /* Question Grid Items */
    .question-number { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); border: 2px solid transparent; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    .question-number:hover { transform: translateY(-3px) scale(1.1); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15); }
    .question-number:active { transform: scale(0.95); }
    .question-number.unattempted { background: #f3f4f6; color: #6b7280; border-color: #e5e7eb; }
    .dark .question-number.unattempted { background: #374151; color: #9ca3af; border-color: #4b5563; }
    .question-number.correct { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-color: #059669; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
    .question-number.wrong { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border-color: #dc2626; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
    .question-number.active { border-color: #f59e0b; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3); transform: scale(1.15); }

    /* Mobile Bottom Sheet */
    #mobile-bottom-sheet.sheet-open { transform: translateY(0); }
    #mobile-bottom-sheet-overlay.overlay-open { opacity: 1; }
    #mobile-menu-fab { animation: fab-pulse 2s ease-in-out infinite; }
    @keyframes fab-pulse { 0%, 100% { box-shadow: 0 8px 24px rgba(245, 158, 11, 0.4); } 50% { box-shadow: 0 8px 32px rgba(245, 158, 11, 0.7), 0 0 0 8px rgba(245, 158, 11, 0.1); } }
    
    @keyframes shake { 0%, 100% { transform: translateX(0) scale(0.95); } 25% { transform: translateX(-5px) scale(0.95); } 50% { transform: translateX(5px) scale(0.95); } 75% { transform: translateX(-3px) scale(0.95); } }
    
    /* Enhanced button transitions */
    .option-btn {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .option-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .option-btn:active:not(:disabled) {
      transform: translateY(0) scale(0.98);
    }

    @media (max-width: 1024px) {
      .question-number { width: 40px; height: 40px; font-size: 14px; }
      #mobile-question-grid .question-number { width: 44px; height: 44px; font-size: 15px; }
    }

    html, body { overflow: hidden; height: 100%; width: 100%; position: fixed; }
    #quiz-container { overflow: hidden; }
    #question-navigator { -webkit-overflow-scrolling: touch; }
    .overflow-y-auto { -webkit-overflow-scrolling: touch; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 via-orange-50 to-amber-50 dark:from-gray-900 dark:via-gray-800 dark:to-slate-900 text-gray-900 dark:text-gray-100 selection:bg-amber-200/60 transition-colors duration-300">
  <!-- Animated Background -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
    <div class="absolute top-20 left-10 w-72 h-72 bg-amber-300/20 dark:bg-amber-500/10 rounded-full blur-3xl animate-float"></div>
    <div class="absolute bottom-20 right-10 w-96 h-96 bg-orange-300/20 dark:bg-orange-500/10 rounded-full blur-3xl animate-float" style="animation-delay: 1s;"></div>
  </div>

  <!-- Navbar -->
  <header class="glass-effect backdrop-blur-lg bg-white/80 dark:bg-gray-900/80 shadow-lg sticky top-0 z-50 border-b border-gray-200/50 dark:border-gray-700/50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center shadow-lg animate-glow">
            <i class="fas fa-file-alt text-white text-xl"></i>
          </div>
          <div>
            <h1 id="navbar-date-display" class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">Subject Practice</h1>
            <p id="navbar-date-subtitle" class="text-xs text-gray-600 dark:text-gray-400">Loading...</p>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <button id="themeToggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
            <i class="fas fa-moon dark:fa-sun text-gray-700 dark:text-gray-300"></i>
          </button>
          <nav class="hidden lg:flex gap-1 font-medium">
            <a href="/upsc-notes/" class="px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300 transition-all">Home</a>
            <a href="/upsc-notes/subjectpractice.html" class="px-4 py-2 rounded-lg bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 font-semibold transition-all">Back to Subjects</a>
            <a href="/upsc-notes/practice.html" class="px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300 transition-all">Practice</a>
            <a href="/upsc-notes/pyq.html" class="px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300 transition-all">PYQs</a>
          </nav>
        </div>
      </div>
    </div>
  </header>

  <!-- Fullscreen Prompt -->
  <div id="fullscreen-prompt" class="fixed inset-0 z-[110] flex items-center justify-center bg-gradient-to-br from-gray-900 via-gray-800 to-slate-900">
    <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-8 max-w-md mx-4 text-center animate-fade-in">
      <div class="w-20 h-20 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-float">
        <i class="fas fa-expand text-white text-3xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-3">Enter Fullscreen Mode</h2>
      <p class="text-gray-600 dark:text-gray-300 mb-6">Experience Subject Practice in fullscreen. Focus better, learn faster!</p>
      <div class="space-y-3">
        <button id="enter-fullscreen" class="w-full inline-flex items-center justify-center gap-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white px-6 py-4 text-lg font-semibold shadow-lg transition-all hover:scale-105">
          <i class="fas fa-expand-arrows-alt"></i><span>Start in Fullscreen</span>
        </button>
        <button id="skip-fullscreen" class="w-full inline-flex items-center justify-center gap-2 rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 text-sm font-medium transition-all">
          <span>Continue Without Fullscreen</span>
        </button>
      </div>
      <p class="text-xs text-gray-500 dark:text-gray-400 mt-4">Press <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded">F11</kbd> anytime to toggle</p>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-white/90 dark:bg-gray-900/90">
    <div class="text-center">
      <div class="text-xl font-semibold mb-3 text-gray-800 dark:text-white">Preparing PYQs‚Ä¶</div>
      <div class="w-12 h-12 border-4 border-amber-400 border-t-transparent rounded-full animate-spin mx-auto"></div>
    </div>
  </div>

  <!-- Floating Action Button (Mobile) -->
  <button id="mobile-menu-fab" class="lg:hidden fixed bottom-24 right-4 z-50 w-14 h-14 rounded-full bg-gradient-to-r from-amber-500 to-orange-600 shadow-2xl flex items-center justify-center text-white text-xl hover:scale-110 active:scale-95 transition-all hidden">
    <i class="fas fa-grip-vertical"></i>
  </button>

  <!-- Quiz Container -->
  <div id="quiz-container" class="fixed inset-0 flex hidden">
    <!-- Desktop Sidebar -->
    <aside id="question-navigator" class="hidden lg:block w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 overflow-y-auto h-full shadow-xl">
      <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4 z-10">
        <h2 class="text-sm font-bold text-gray-800 dark:text-white mb-3">Questions</h2>
        <p id="date-info" class="text-xs text-gray-600 dark:text-gray-400 mb-3"></p>
        <div class="flex items-center gap-2 text-xs">
          <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span>Correct</span>
          <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span>Wrong</span>
          <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-gray-300 dark:bg-gray-600"></span>Unattempted</span>
        </div>
      </div>
      <div id="question-grid" class="grid grid-cols-6 gap-2 p-4"></div>
      <div class="sticky bottom-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4">
        <div class="space-y-2 mb-3">
          <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400">
            <span>Score:</span>
            <span class="font-bold text-amber-600 dark:text-amber-400"><span id="score-display">0</span> / <span id="total-questions">0</span></span>
          </div>
          <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400">
            <span>Accuracy:</span>
            <span class="font-bold text-green-600 dark:text-green-400" id="accuracy-display">0%</span>
          </div>
        </div>
        <div class="h-2 w-full bg-amber-100 dark:bg-amber-900/30 rounded-full overflow-hidden shadow-inner mb-3">
          <div id="progress-bar" class="h-full bg-gradient-to-r from-amber-500 via-orange-500 to-red-500 transition-all duration-500" style="width:0%"></div>
        </div>
        <div class="space-y-2">
          <button id="clear-data-btn" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-red-500 hover:bg-red-600 text-white px-3 py-2 text-sm transition-all shadow-md">
            <i class="fa-solid fa-trash"></i><span>Clear Data</span>
          </button>
          <button id="reset-session" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-white dark:bg-gray-700 border border-amber-300 dark:border-amber-600 px-3 py-2 text-sm hover:bg-amber-50 dark:hover:bg-gray-600 transition-all">
            <i class="fa-solid fa-rotate"></i><span>Reset Session</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto relative">
      <div class="sticky top-0 z-30 glass-effect backdrop-blur-lg bg-white/90 dark:bg-gray-900/90 border-b border-gray-200 dark:border-gray-700 px-4 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <button id="toggle-nav" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
              <i class="fas fa-bars text-gray-700 dark:text-gray-300"></i>
            </button>
            <div class="flex items-center gap-2">
              <span id="counter" class="text-sm font-bold text-gray-800 dark:text-white">0 / 0</span>
              <span id="streak-indicator" class="px-2 py-1 bg-gradient-to-r from-orange-400 to-red-500 text-white rounded-full text-xs font-bold hidden">
                üî• <span id="streak-count">0</span> Streak!
              </span>
            </div>
          </div>
          <a href="/upsc-notes/subjectpractice.html" class="text-sm text-gray-700 dark:text-gray-300 hover:text-amber-600 dark:hover:text-amber-400 transition-colors">
            <i class="fas fa-arrow-left mr-1"></i><span class="hidden sm:inline">Back to Subjects</span>
          </a>
        </div>
      </div>
      <div class="h-[calc(100vh-8rem)] overflow-y-auto">
        <div id="question-carousel" class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6"></div>
      </div>
      <div class="fixed bottom-0 left-0 lg:left-72 right-0 z-30 glass-effect backdrop-blur-lg bg-white/90 dark:bg-gray-900/90 border-t border-gray-200 dark:border-gray-700 px-4 py-3 lg:py-4">
        <div class="max-w-4xl mx-auto flex items-center justify-between gap-2 sm:gap-3">
          <button id="prev-btn" class="inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-gray-700 to-gray-900 dark:from-gray-600 dark:to-gray-800 text-white px-4 sm:px-6 py-2.5 sm:py-3 shadow-lg disabled:opacity-40 disabled:cursor-not-allowed transition-all hover:scale-105 disabled:hover:scale-100 text-sm sm:text-base">
            <i class="fa-solid fa-arrow-left"></i><span class="hidden sm:inline">Previous</span>
          </button>
          <div class="flex items-center gap-1 sm:gap-2">
            <button id="jump-first" class="p-2 sm:p-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-gray-700 dark:text-gray-300 text-sm sm:text-base" title="First Question">
              <i class="fas fa-fast-backward"></i>
            </button>
            <button id="exit-fullscreen-btn" class="p-2 sm:p-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-gray-700 dark:text-gray-300 text-sm sm:text-base hidden" title="Exit Fullscreen">
              <i class="fas fa-compress"></i>
            </button>
            <button id="jump-last" class="p-2 sm:p-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-gray-700 dark:text-gray-300 text-sm sm:text-base" title="Last Question">
              <i class="fas fa-fast-forward"></i>
            </button>
          </div>
          <button id="next-btn" class="inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white px-4 sm:px-6 py-2.5 sm:py-3 shadow-lg disabled:opacity-40 disabled:cursor-not-allowed transition-all hover:scale-105 disabled:hover:scale-100 text-sm sm:text-base">
            <span class="hidden sm:inline">Next</span><i class="fa-solid fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Bottom Sheet -->
  <div id="mobile-bottom-sheet-overlay" class="lg:hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden transition-opacity duration-300" onclick="closeMobileSheet()"></div>
  <div id="mobile-bottom-sheet" class="lg:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 rounded-t-3xl shadow-2xl z-[70] transform translate-y-full transition-transform duration-300 ease-out max-h-[85vh] flex flex-col">
    <div class="flex justify-center py-3 border-b border-gray-200 dark:border-gray-700">
      <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
    </div>
    <div class="px-5 py-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-bold text-gray-900 dark:text-white">Question Navigator</h2>
        <button onclick="closeMobileSheet()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
          <i class="fas fa-times text-gray-600 dark:text-gray-300"></i>
        </button>
      </div>
      <p id="date-info-mobile" class="text-xs text-gray-600 dark:text-gray-400 mb-3"></p>
      <div class="flex items-center gap-3 text-xs flex-wrap">
        <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-full bg-green-500"></span>Correct</span>
        <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-full bg-red-500"></span>Wrong</span>
        <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-full bg-gray-300 dark:bg-gray-600"></span>Unattempted</span>
      </div>
    </div>
    <div class="flex-1 overflow-y-auto p-5">
      <div id="mobile-question-grid" class="grid grid-cols-6 gap-2.5"></div>
    </div>
    <div class="px-5 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 space-y-3">
      <div class="grid grid-cols-2 gap-2 text-xs text-gray-600 dark:text-gray-400">
        <div class="flex justify-between">
          <span>Score:</span>
          <span class="font-bold text-amber-600 dark:text-amber-400"><span id="mobile-score-display">0</span> / <span id="mobile-total-questions">0</span></span>
        </div>
        <div class="flex justify-between">
          <span>Accuracy:</span>
          <span class="font-bold text-green-600 dark:text-green-400" id="mobile-accuracy-display">0%</span>
        </div>
      </div>
      <div class="h-2 w-full bg-amber-100 dark:bg-amber-900/30 rounded-full overflow-hidden shadow-inner">
        <div id="mobile-progress-bar" class="h-full bg-gradient-to-r from-amber-500 via-orange-500 to-red-500 transition-all duration-500" style="width:0%"></div>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <button id="mobile-clear-data-btn" class="inline-flex items-center justify-center gap-2 rounded-xl bg-red-500 hover:bg-red-600 active:scale-95 text-white px-4 py-3 text-sm font-semibold transition-all shadow-lg">
          <i class="fa-solid fa-trash"></i><span>Clear Data</span>
        </button>
        <button id="mobile-reset-session" class="inline-flex items-center justify-center gap-2 rounded-xl bg-white dark:bg-gray-700 border-2 border-amber-300 dark:border-amber-600 hover:bg-amber-50 dark:hover:bg-gray-600 active:scale-95 px-4 py-3 text-sm font-semibold transition-all text-gray-900 dark:text-white">
          <i class="fa-solid fa-rotate"></i><span>Reset</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="solution-modal" class="hidden fixed inset-0 bg-black/50 items-center justify-center z-[80]">
    <div class="bg-white dark:bg-gray-800 w-[92%] md:max-w-xl rounded-2xl shadow-xl relative p-5 md:p-6 max-h-[90vh] overflow-y-auto">
      <button id="modal-close" class="absolute top-3 right-3 text-gray-600 dark:text-gray-300 text-xl"><i class="fas fa-times"></i></button>
      <h3 class="text-lg font-bold mb-3 text-gray-800 dark:text-white">Explanation</h3>
      <div id="modal-content" class="prose prose-sm max-w-none dark:prose-invert"></div>
    </div>
  </div>

  <script>
    // localStorage Key
    function getStorageKey() {
      const { subject, book, chapter } = getUrlParams();
      return `upsc_subject_${subject}_${book}_${chapter}`;
    }

    function saveToLocalStorage() {
      const storageKey = getStorageKey();
      const data = {
        answers: Array.from(session.answers.entries()),
        bookmarks: Array.from(session.bookmarks),
        index: session.index,
        score: session.score,
        streak: session.streak,
        filter: session.filter,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem(storageKey, JSON.stringify(data));
      showSavedBadge();
    }

    function loadFromLocalStorage() {
      const storageKey = getStorageKey();
      const saved = localStorage.getItem(storageKey);
      if (!saved) return false;
      try {
        const data = JSON.parse(saved);
        session.answers = new Map(data.answers);
        session.bookmarks = new Set(data.bookmarks);
        session.index = data.index || 0;
        session.score = data.score || 0;
        session.streak = data.streak || 0;
        session.filter = data.filter || 'all';
        return true;
      } catch (e) {
        return false;
      }
    }

    function clearLocalStorage() {
      const storageKey = getStorageKey();
      if (confirm('‚ö†Ô∏è Delete all saved progress for this PYQ?\n\nThis action cannot be undone!')) {
        localStorage.removeItem(storageKey);
        const conf = document.createElement('div');
        conf.className = 'saved-badge';
        conf.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
        conf.innerHTML = '<i class="fas fa-trash mr-2"></i>Data Deleted!';
        document.body.appendChild(conf);
        setTimeout(() => {
          conf.remove();
          window.location.reload();
        }, 1500);
      }
    }

    function showSavedBadge() {
      const badge = document.createElement('div');
      badge.className = 'saved-badge';
      badge.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Progress Saved!';
      document.body.appendChild(badge);
      setTimeout(() => badge.remove(), 2000);
    }

    const session = {
      data: [],
      fullData: [],
      index: 0,
      answers: new Map(),
      bookmarks: new Set(),
      filter: 'all',
      score: 0,
      streak: 0,
      maxStreak: 0
    };

    const container = document.getElementById('question-carousel');
    const modal = document.getElementById('solution-modal');
    const modalClose = document.getElementById('modal-close');
    const modalContent = document.getElementById('modal-content');
    const loader = document.getElementById('loader');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const counter = document.getElementById('counter');
    const progressBar = document.getElementById('progress-bar');
    const scoreDisplay = document.getElementById('score-display');
    const totalQuestionsDisplay = document.getElementById('total-questions');
    const accuracyDisplay = document.getElementById('accuracy-display');
    const streakIndicator = document.getElementById('streak-indicator');
    const streakCount = document.getElementById('streak-count');
    const dateInfo = document.getElementById('date-info');

    function getUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        subject: urlParams.get('subject') || '',
        book: urlParams.get('book') || '',
        chapter: urlParams.get('chapter') || ''
      };
    }

    function sanitizeHTML(html) {
      return DOMPurify.sanitize(html, { ALLOWED_ATTR: ['href', 'target', 'rel', 'src', 'alt', 'title'] });
    }

    function renderMarkdown(md) {
      return sanitizeHTML(marked.parse(md || ''));
    }

    function updateHeader() {
      const { subject, book, chapter } = getUrlParams();
      const dateText = `ÔøΩ ${subject.toUpperCase()} - ${chapter}`;
      if (dateInfo) dateInfo.textContent = dateText;
      const mobileDate = document.getElementById('date-info-mobile');
      if (mobileDate) mobileDate.textContent = dateText;
      const navbarDisplay = document.getElementById('navbar-date-display');
      if (navbarDisplay) navbarDisplay.textContent = subject.charAt(0).toUpperCase() + subject.slice(1);
      const navbarSubtitle = document.getElementById('navbar-date-subtitle');
      if (navbarSubtitle) navbarSubtitle.textContent = book.replace(/-/g, ' ').toUpperCase();
    }

    function createConfetti() {
      const burst = document.createElement('div');
      burst.className = 'confetti-burst';
      const colors = ['#f59e0b', '#f97316', '#10b981', '#3b82f6', '#8b5cf6'];
      for (let i = 0; i < 30; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 - 50 + 'px';
        confetti.style.animationDelay = Math.random() * 0.3 + 's';
        burst.appendChild(confetti);
      }
      document.body.appendChild(burst);
      setTimeout(() => burst.remove(), 2000);
    }

    function createMiniConfetti(element) {
      const rect = element.getBoundingClientRect();
      const colors = ['#10b981', '#059669', '#34d399'];
      
      for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.style.position = 'fixed';
        particle.style.width = '6px';
        particle.style.height = '6px';
        particle.style.background = colors[Math.floor(Math.random() * colors.length)];
        particle.style.borderRadius = '50%';
        particle.style.left = (rect.left + rect.width / 2) + 'px';
        particle.style.top = (rect.top + rect.height / 2) + 'px';
        particle.style.pointerEvents = 'none';
        particle.style.zIndex = '9999';
        
        const angle = (i / 8) * Math.PI * 2;
        const velocity = 30 + Math.random() * 20;
        const vx = Math.cos(angle) * velocity;
        const vy = Math.sin(angle) * velocity;
        
        document.body.appendChild(particle);
        
        let x = 0, y = 0, opacity = 1;
        const animate = () => {
          x += vx * 0.02;
          y += vy * 0.02 + 0.5; // gravity
          opacity -= 0.02;
          
          particle.style.transform = `translate(${x}px, ${y}px)`;
          particle.style.opacity = opacity;
          
          if (opacity > 0) {
            requestAnimationFrame(animate);
          } else {
            particle.remove();
          }
        };
        requestAnimationFrame(animate);
      }
    }

    function finalizeMultipleCorrectQuestion(q, optionsDiv, correctKeys, answeredObj) {
      const selectedSet = new Set(answeredObj.selectedMultiple);
      const correctSet = new Set(correctKeys);
      const isCorrect = selectedSet.size === correctSet.size && 
                       [...selectedSet].every(key => correctSet.has(key));
      
      if (isCorrect) {
        session.score++;
        session.streak++;
        session.maxStreak = Math.max(session.maxStreak, session.streak);
        createConfetti();
      } else {
        session.streak = 0;
      }

      // Update answer object
      answeredObj.selected = answeredObj.selectedMultiple;
      answeredObj.correct = isCorrect;
      session.answers.set(qidOf(q), answeredObj);

      // Disable all buttons and show final state
      Array.from(optionsDiv.children).forEach(btn => {
        btn.disabled = true;
        const text = btn.textContent;
        const key = text.match(/^([A-D])\./)?.[1];
        
        if (!key) return;
        
        const wasSelected = answeredObj.selectedMultiple.includes(key);
        const isCorrectOption = correctKeys.includes(key);
        
        if (wasSelected && isCorrectOption) {
          btn.className = 'option-btn option-correct block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold';
        } else if (wasSelected && !isCorrectOption) {
          btn.className = 'option-btn option-wrong block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold';
        } else if (!wasSelected && isCorrectOption) {
          btn.className = 'option-btn option-reveal block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-medium';
        }
      });

      // Show feedback
      const feedback = document.querySelector('#feedback');
      const expBtn = document.querySelector('#explanation-btn');
      
      feedback.textContent = isCorrect ? '‚úÖ Correct! All right answers selected!' : `‚ùå Wrong! Correct Answers: ${correctKeys.join(', ')}`;
      feedback.className = isCorrect ? 'text-green-700 dark:text-green-400 mt-3 text-base font-bold' : 'text-red-700 dark:text-red-400 mt-3 text-base font-bold';
      expBtn.classList.remove('hidden');

      updateProgressUI();
      saveToLocalStorage();
    }

    function updateProgressUI() {
      const total = session.data.length;
      counter.textContent = `${Math.min(session.index + 1, total)} / ${total}`;
      const attempted = Array.from(session.answers.values()).filter(v => v.selected != null).length;
      const pct = total ? Math.round((attempted / total) * 100) : 0;
      progressBar.style.width = pct + '%';
      
      scoreDisplay.textContent = session.score;
      totalQuestionsDisplay.textContent = total;
      
      const accuracy = attempted > 0 ? Math.round((session.score / attempted) * 100) : 0;
      accuracyDisplay.textContent = accuracy + '%';
      
      if (session.streak >= 3) {
        streakIndicator.classList.remove('hidden');
        streakCount.textContent = session.streak;
        streakIndicator.classList.add('streak-indicator');
        setTimeout(() => streakIndicator.classList.remove('streak-indicator'), 600);
      } else {
        streakIndicator.classList.add('hidden');
      }
      
      if (pct === 25 || pct === 50 || pct === 75 || pct === 100) {
        progressBar.classList.add('progress-celebrate');
        setTimeout(() => progressBar.classList.remove('progress-celebrate'), 1000);
      }

      prevBtn.disabled = session.index <= 0;
      nextBtn.disabled = session.index >= total - 1 || total === 0;

      updateQuestionGrid();
    }

    function qidOf(item) {
      return item.id ?? item._idx;
    }

    function buildOptionKeyed(options) {
      const alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      return options.map((opt, i) => {
        const match = String(opt).match(/^\s*([A-D])[\).:\-]\s*(.*)$/i);
        if (match) return { key: match[1].toUpperCase(), text: match[2] };
        return { key: alpha[i] || String(i + 1), text: String(opt) };
      });
    }

    function renderQuestion(q, idx) {
      const card = document.createElement('div');
      card.className = 'bg-white dark:bg-gray-800 shadow-soft rounded-2xl p-6 md:p-7 card-enter border border-amber-100 dark:border-amber-900/30';

      // Show date metadata if available
      if (q.date && q.month && q.year) {
        const dateDiv = document.createElement('div');
        dateDiv.className = 'flex items-center gap-2 mb-3 text-xs text-gray-500 dark:text-gray-400';
        dateDiv.innerHTML = `<i class="fas fa-calendar-day text-amber-500"></i> <span>${q.date} ${q.month}, ${q.year}</span>`;
        card.appendChild(dateDiv);
      }

      const h = document.createElement('h3');
      h.className = 'text-lg font-semibold text-gray-800 dark:text-gray-100';
      h.textContent = `Q${idx + 1}. ${q.question}`;
      card.appendChild(h);

      // Add instruction based on question type
      const instruction = document.createElement('p');
      instruction.className = 'text-sm font-medium mt-2 mb-3';
      if (q.question_type === 'multiple_correct') {
        instruction.textContent = 'Instructions: Select all correct options (Multiple answers may be correct)';
        instruction.className += ' text-blue-700 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 px-3 py-2 rounded-lg border-l-4 border-blue-400';
      } else {
        instruction.textContent = 'Instructions: Select the single correct option';
        instruction.className += ' text-green-700 dark:text-green-400 bg-green-50 dark:bg-green-900/20 px-3 py-2 rounded-lg border-l-4 border-green-400';
      }
      card.appendChild(instruction);

      if (Array.isArray(q.statements) && q.statements.length) {
        const list = document.createElement('ol');
        list.className = 'list-decimal pl-6 mt-3 space-y-1 text-[15px] text-gray-800 dark:text-gray-200';
        q.statements.forEach(s => {
          const li = document.createElement('li');
          li.textContent = s;
          list.appendChild(li);
        });
        card.appendChild(list);
      }

      const optionsDiv = document.createElement('div');
      optionsDiv.className = 'mt-4 space-y-3';
      const keyed = buildOptionKeyed(q.options || []);
      let answeredObj = session.answers.get(qidOf(q)) || { selected: null, selectedMultiple: [], correct: null };
      
      // Handle correct answers for both single and multiple types
      let correctKeys = [];
      if (q.question_type === 'multiple_correct') {
        correctKeys = (q.correct_options || []).map(opt => 
          keyed.find(k => k.text.trim() === String(opt).trim())?.key
        ).filter(Boolean);
      } else {
        // Handle both new format (correct_option) and legacy formats
        let correctKey = null;
        
        if (q.correct_key) {
          correctKey = q.correct_key;
        } else if (q.correct_option) {
          // Find the option key that matches the correct answer text
          const foundKey = keyed.find(k => k.text.trim() === String(q.correct_option).trim())?.key;
          if (foundKey) {
            correctKey = foundKey;
          }
        } else if (q.correct_options && q.correct_options.length > 0) {
          // Handle legacy correct_options for single answer
          const foundKey = keyed.find(k => k.text.trim() === String(q.correct_options[0]).trim())?.key;
          if (foundKey) {
            correctKey = foundKey;
          }
        }
        
        if (correctKey) correctKeys = [correctKey];
      }

      // No submit button needed - instant feedback on selection

      keyed.forEach(opt => {
        const btn = document.createElement('button');
        btn.textContent = `${opt.key}. ${opt.text}`;
        btn.className = 'option-btn block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 border-amber-200 dark:border-amber-700 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-gray-700 dark:to-gray-600 font-medium';
        optionsDiv.appendChild(btn);

        // Show previous answers if any
        if (answeredObj.selected != null) {
          btn.disabled = true;
          if (q.question_type === 'multiple_correct') {
            const isSelected = answeredObj.selectedMultiple?.includes(opt.key);
            const isCorrect = correctKeys.includes(opt.key);
            if (isSelected && isCorrect) {
              btn.className = 'option-btn option-correct block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold';
            } else if (isSelected && !isCorrect) {
              btn.className = 'option-btn option-wrong block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold';
            } else if (!isSelected && isCorrect) {
              btn.className = 'option-btn option-reveal block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-medium';
            }
          } else {
            if (opt.key === answeredObj.selected && answeredObj.correct) {
              btn.className = 'option-btn option-correct block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold';
            } else if (opt.key === answeredObj.selected && !answeredObj.correct) {
              btn.className = 'option-btn option-wrong block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold';
            } else if (correctKeys.includes(opt.key)) {
              btn.className = 'option-btn option-reveal block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-medium';
            }
          }
        }

        btn.onclick = () => {
          if (session.answers.get(qidOf(q))?.selected != null) return;

          if (q.question_type === 'multiple_correct') {
            // Instant feedback for multiple correct
            const isCorrectOption = correctKeys.includes(opt.key);
            
            // Add immediate visual feedback with animation
            if (isCorrectOption) {
              btn.className = 'option-btn option-correct block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold transform transition-all duration-300';
              btn.style.transform = 'scale(1.05)';
              btn.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.6)';
              
              // Create mini confetti effect
              createMiniConfetti(btn);
              
              setTimeout(() => {
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = '';
              }, 300);
            } else {
              btn.className = 'option-btn option-wrong block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold transform transition-all duration-300';
              btn.style.transform = 'scale(0.95)';
              
              // Shake animation for wrong answers
              btn.style.animation = 'shake 0.5s ease-in-out';
              
              setTimeout(() => {
                btn.style.transform = 'scale(1)';
                btn.style.animation = '';
              }, 500);
            }

            // Toggle selection for multiple correct
            if (!answeredObj.selectedMultiple) answeredObj.selectedMultiple = [];
            const index = answeredObj.selectedMultiple.indexOf(opt.key);
            if (index > -1) {
              answeredObj.selectedMultiple.splice(index, 1);
            } else {
              answeredObj.selectedMultiple.push(opt.key);
            }

            // Check if quiz is complete and provide final feedback
            if (answeredObj.selectedMultiple.length > 0) {
              const selectedSet = new Set(answeredObj.selectedMultiple);
              const correctSet = new Set(correctKeys);
              const allCorrectSelected = [...correctSet].every(key => selectedSet.has(key));
              const noIncorrectSelected = [...selectedSet].every(key => correctSet.has(key));
              
              if (allCorrectSelected && noIncorrectSelected && selectedSet.size === correctSet.size) {
                // All correct answers found, finalize the question
                setTimeout(() => {
                  finalizeMultipleCorrectQuestion(q, optionsDiv, correctKeys, answeredObj);
                }, 800);
              }
            }
          } else {
            // Single correct answer logic
            const isCorrect = correctKeys.includes(opt.key);
            if (isCorrect) {
              session.score++;
              session.streak++;
              session.maxStreak = Math.max(session.maxStreak, session.streak);
            } else {
              session.streak = 0;
            }

            answeredObj = { selected: opt.key, correct: isCorrect };
            session.answers.set(qidOf(q), answeredObj);

            Array.from(optionsDiv.children).forEach(b => {
              b.disabled = true;
              const text = b.textContent;
              const k = text.match(/^([A-D])\./)?.[1];
              if (k === opt.key && isCorrect) {
                b.className = 'option-btn option-correct block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold transform transition-all duration-500';
                // Add bounce and glow effect for correct answer
                b.style.animation = 'correct-bounce 0.6s ease-out';
                b.style.boxShadow = '0 0 25px rgba(16, 185, 129, 0.8)';
                createConfetti();
                setTimeout(() => {
                  b.style.animation = '';
                  b.style.boxShadow = '';
                }, 600);
              } else if (k === opt.key && !isCorrect) {
                b.className = 'option-btn option-wrong block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold transform transition-all duration-300';
                // Add shake effect for wrong answer
                b.style.animation = 'wrong-shake 0.5s ease-in-out';
                setTimeout(() => {
                  b.style.animation = '';
                }, 500);
              } else if (correctKeys.includes(k)) {
                b.className = 'option-btn option-reveal block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-medium transform transition-all duration-400';
                // Add reveal glow effect
                b.style.animation = 'reveal-glow 1s ease-out';
                setTimeout(() => {
                  b.style.animation = '';
                }, 1000);
              }
            });

            feedback.textContent = isCorrect ? '‚úÖ Correct! Well done!' : `‚ùå Wrong! Correct Answer: ${correctKeys.join(', ')}`;
            feedback.className = isCorrect ? 'text-green-700 dark:text-green-400 mt-3 text-base font-bold' : 'text-red-700 dark:text-red-400 mt-3 text-base font-bold';
            expBtn.classList.remove('hidden');

            updateProgressUI();
            saveToLocalStorage();
          }
        };
      });

      // Add submit button functionality for multiple correct
      if (submitBtn) {
        submitBtn.onclick = () => {
          if (!answeredObj.selectedMultiple || answeredObj.selectedMultiple.length === 0) return;
          
          // Check if all correct answers are selected and no incorrect ones
          const selectedSet = new Set(answeredObj.selectedMultiple);
          const correctSet = new Set(correctKeys);
          const isCorrect = selectedSet.size === correctSet.size && 
                           [...selectedSet].every(key => correctSet.has(key));

          if (isCorrect) {
            session.score++;
            session.streak++;
            session.maxStreak = Math.max(session.maxStreak, session.streak);
            createConfetti();
          } else {
            session.streak = 0;
          }

          answeredObj.selected = 'submitted';
          answeredObj.correct = isCorrect;
          session.answers.set(qidOf(q), answeredObj);

          // Update button appearances
          Array.from(optionsDiv.children).forEach(b => {
            b.disabled = true;
            const text = b.textContent;
            const k = text.match(/^([A-D])\./)?.[1];
            const isSelected = answeredObj.selectedMultiple.includes(k);
            const isCorrectOption = correctKeys.includes(k);
            
            if (isSelected && isCorrectOption) {
              b.className = 'option-btn option-correct block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold';
            } else if (isSelected && !isCorrectOption) {
              b.className = 'option-btn option-wrong block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-bold';
            } else if (!isSelected && isCorrectOption) {
              b.className = 'option-btn option-reveal block w-full text-left px-5 py-4 text-[15px] rounded-xl border-2 font-medium';
            }
          });

          submitBtn.style.display = 'none';
          feedback.textContent = isCorrect ? '‚úÖ Correct! Well done!' : `‚ùå Wrong! Correct Answers: ${correctKeys.join(', ')}`;
          feedback.className = isCorrect ? 'text-green-700 dark:text-green-400 mt-3 text-base font-bold' : 'text-red-700 dark:text-red-400 mt-3 text-base font-bold';
          expBtn.classList.remove('hidden');

          updateProgressUI();
          saveToLocalStorage();
        };
      }
      // Submit button functionality removed - now using instant feedback

      card.appendChild(optionsDiv);

      const feedback = document.createElement('p');
      if (answeredObj.selected != null) {
        if (q.question_type === 'multiple_correct') {
          feedback.textContent = answeredObj.correct ? '‚úÖ Correct! Well done!' : `‚ùå Wrong! Correct Answers: ${correctKeys.join(', ')}`;
        } else {
          feedback.textContent = answeredObj.correct ? '‚úÖ Correct! Well done!' : `‚ùå Wrong! Correct Answer: ${correctKeys.join(', ')}`;
        }
        feedback.className = answeredObj.correct ? 'text-green-700 dark:text-green-400 mt-3 text-base font-bold' : 'text-red-700 dark:text-red-400 mt-3 text-base font-bold';
      } else {
        feedback.className = 'mt-3 text-sm text-gray-500 dark:text-gray-400 italic';
        if (q.question_type === 'multiple_correct') {
          feedback.textContent = 'üí° Select all correct options and click Submit to check your answer.';
        } else {
          feedback.textContent = 'üí° Select an option to check your answer.';
        }
      }
      card.appendChild(feedback);

      const expBtn = document.createElement('button');
      expBtn.className = 'mt-4 inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white px-5 py-3 text-sm font-semibold shadow-lg transition-all hover:scale-105 ' + (answeredObj.selected != null ? '' : 'hidden');
      expBtn.innerHTML = '<i class="fa-solid fa-lightbulb"></i><span>View Explanation</span>';
      expBtn.addEventListener('click', () => openModal(renderMarkdown(q.explanation || 'No explanation provided.')));
      card.appendChild(expBtn);

      return card;
    }

    function renderPage() {
      container.innerHTML = '';
      if (!session.data.length) {
        container.innerHTML = `<p class="text-center text-red-600 mt-6">‚ö†Ô∏è No questions found.</p>`;
        return;
      }
      const card = renderQuestion(session.data[session.index], session.index);
      container.appendChild(card);
      updateProgressUI();
    }

    function createQuestionButton(idx, isMobile = false) {
      const q = session.data[idx];
      const btn = document.createElement('button');
      btn.className = 'question-number unattempted';
      btn.textContent = idx + 1;
      const answer = session.answers.get(qidOf(q));
      if (answer?.selected != null) {
        btn.className = answer.correct ? 'question-number correct' : 'question-number wrong';
      }
      if (idx === session.index) btn.classList.add('active');
      btn.addEventListener('click', () => {
        session.index = idx;
        renderPage();
        if (isMobile) closeMobileSheet();
      });
      return btn;
    }

    function updateQuestionGrid() {
      const grid = document.getElementById('question-grid');
      if (grid) {
        grid.innerHTML = '';
        session.data.forEach((q, idx) => grid.appendChild(createQuestionButton(idx)));
      }
      const mobileGrid = document.getElementById('mobile-question-grid');
      if (mobileGrid) {
        mobileGrid.innerHTML = '';
        session.data.forEach((q, idx) => mobileGrid.appendChild(createQuestionButton(idx, true)));
      }
      document.getElementById('mobile-score-display').textContent = session.score;
      document.getElementById('mobile-total-questions').textContent = session.data.length;
      const attempted = Array.from(session.answers.values()).filter(v => v.selected != null).length;
      const accuracy = attempted > 0 ? Math.round((session.score / attempted) * 100) : 0;
      document.getElementById('mobile-accuracy-display').textContent = accuracy + '%';
      const total = session.data.length;
      const pct = total ? Math.round((attempted / total) * 100) : 0;
      document.getElementById('mobile-progress-bar').style.width = pct + '%';
    }

    function openMobileSheet() {
      const sheet = document.getElementById('mobile-bottom-sheet');
      const overlay = document.getElementById('mobile-bottom-sheet-overlay');
      overlay.classList.remove('hidden');
      overlay.classList.add('overlay-open');
      setTimeout(() => sheet.classList.add('sheet-open'), 10);
      document.body.style.overflow = 'hidden';
    }

    function closeMobileSheet() {
      const sheet = document.getElementById('mobile-bottom-sheet');
      const overlay = document.getElementById('mobile-bottom-sheet-overlay');
      sheet.classList.remove('sheet-open');
      overlay.classList.remove('overlay-open');
      setTimeout(() => overlay.classList.add('hidden'), 300);
      document.body.style.overflow = '';
    }
    window.closeMobileSheet = closeMobileSheet;

    function applyFilter(subject) {
      session.filter = subject;
      if (subject === 'all') {
        session.data = session.fullData.slice();
      } else if (subject === 'review') {
        session.data = session.fullData.filter(q => session.bookmarks.has(qidOf(q)));
      } else {
        session.data = session.fullData.filter(q => (q.subject || '').toLowerCase() === subject.toLowerCase());
      }
      if (session.index >= session.data.length) session.index = Math.max(0, session.data.length - 1);
      renderPage();
    }

    function enterFullscreen() {
      const elem = document.documentElement;
      if (elem.requestFullscreen) elem.requestFullscreen();
      else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
      else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
      document.getElementById('exit-fullscreen-btn')?.classList.remove('hidden');
    }

    function exitFullscreen() {
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      else if (document.msExitFullscreen) document.msExitFullscreen();
      document.getElementById('exit-fullscreen-btn')?.classList.add('hidden');
    }

    async function startQuiz() {
      document.getElementById('fullscreen-prompt').classList.add('hidden');
      document.getElementById('quiz-container').classList.remove('hidden');
      document.getElementById('mobile-menu-fab')?.classList.remove('hidden');
      document.getElementById('loader').classList.remove('hidden');
      
      try {
        await loadQuestions();
      } catch (error) {
        console.error('Error loading questions:', error);
        document.getElementById('loader').classList.add('hidden');
        container.innerHTML = `<p class="text-center text-red-600 dark:text-red-400 mt-6">‚ùå Failed to load questions. Please try again.</p>`;
      }
    }

    document.getElementById('enter-fullscreen')?.addEventListener('click', () => {
      enterFullscreen();
      startQuiz();
    });
    document.getElementById('skip-fullscreen')?.addEventListener('click', startQuiz);
    document.getElementById('exit-fullscreen-btn')?.addEventListener('click', exitFullscreen);

    function openModal(html) {
      modalContent.innerHTML = html;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.classList.add('modal-open');
      modalClose.focus();
    }

    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.classList.remove('modal-open');
    }

    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal(); });

    prevBtn.addEventListener('click', () => {
      if (session.index > 0) { session.index--; renderPage(); }
    });
    nextBtn.addEventListener('click', () => {
      if (session.index < session.data.length - 1) { session.index++; renderPage(); }
    });

    document.getElementById('jump-first')?.addEventListener('click', () => {
      if (session.index !== 0) { session.index = 0; renderPage(); }
    });
    document.getElementById('jump-last')?.addEventListener('click', () => {
      const lastIndex = session.data.length - 1;
      if (session.index !== lastIndex && lastIndex >= 0) { session.index = lastIndex; renderPage(); }
    });

    document.getElementById('toggle-nav')?.addEventListener('click', openMobileSheet);
    document.getElementById('mobile-menu-fab')?.addEventListener('click', openMobileSheet);
    document.getElementById('mobile-clear-data-btn')?.addEventListener('click', clearLocalStorage);
    document.getElementById('clear-data-btn')?.addEventListener('click', clearLocalStorage);

    document.getElementById('mobile-reset-session')?.addEventListener('click', () => {
      if (!confirm('üîÑ Reset current session?\n\nAnswers will be cleared but saved data will remain in storage.')) return;
      session.answers.clear();
      session.bookmarks.clear();
      session.index = 0;
      session.score = 0;
      session.streak = 0;
      renderPage();
      saveToLocalStorage();
      closeMobileSheet();
    });

    document.getElementById('reset-session')?.addEventListener('click', () => {
      if (!confirm('üîÑ Reset current session?\n\nAnswers will be cleared but saved data will remain in storage.')) return;
      session.answers.clear();
      session.bookmarks.clear();
      session.index = 0;
      session.score = 0;
      session.streak = 0;
      renderPage();
      saveToLocalStorage();
    });

    // Subject filter removed for subject-specific practice

    let touchStartX = 0;
    container.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, { passive: true });
    container.addEventListener('touchend', e => {
      const diffX = e.changedTouches[0].clientX - touchStartX;
      if (diffX > 50 && session.index > 0) { session.index--; renderPage(); }
      else if (diffX < -50 && session.index < session.data.length - 1) { session.index++; renderPage(); }
    }, { passive: true });

    window.addEventListener('keydown', (e) => {
      if (!modal.classList.contains('hidden')) return;
      if (e.key === 'ArrowLeft') { if (session.index > 0) { session.index--; renderPage(); } }
      if (e.key === 'ArrowRight') { if (session.index < session.data.length - 1) { session.index++; renderPage(); } }
    });

    async function loadQuestions() {
      updateHeader();
      const urlParams = new URLSearchParams(window.location.search);
      const category = urlParams.get('category');
      const book = urlParams.get('book');
      const chapter = urlParams.get('chapter');
      const type = urlParams.get('type');
      
      // Check for new chapter-based system
      if (category && book) {
        try {
          let questions = [];
          
          if (type === 'chapter' && chapter) {
            // Load specific chapter questions
            const res = await fetch(`./question/subjects/history/${book}.json`, { cache: 'no-store' });
            const allQuestions = await res.json();
            questions = allQuestions.filter(q => q.chapter_id == chapter);
          } else if (type === 'book') {
            // Load all questions for the book
            const res = await fetch(`./question/subjects/history/${book}.json`, { cache: 'no-store' });
            questions = await res.json();
          }
          
          session.fullData = (questions || []).map((q, i) => ({ ...q, _idx: i }));
          
        } catch (err) {
          console.error('New system failed, trying old system:', err);
          // Fallback to old system
          const { subject, book: oldBook, chapter: oldChapter } = getUrlParams();
          
          // Only try old system if we have valid parameters
          if (subject && oldBook && oldChapter) {
            try {
              const res = await fetch(`./question/subjects/${subject}/${oldBook}-${oldChapter}.json`, { cache: 'no-store' });
              const raw = await res.json();
              session.fullData = (raw || []).map((q, i) => ({ ...q, _idx: i }));
            } catch (oldErr) {
              console.error('Both systems failed:', oldErr);
              container.innerHTML = `<p class="text-center text-red-600 dark:text-red-400 mt-6">‚ùå Questions coming soon or failed to load.</p>`;
              document.getElementById('loader').classList.add('hidden');
              return;
            }
          } else {
            console.error('Missing required URL parameters for fallback system');
            container.innerHTML = `<p class="text-center text-red-600 dark:text-red-400 mt-6">‚ùå Questions coming soon or failed to load.</p>`;
            document.getElementById('loader').classList.add('hidden');
            return;
          }
        }
      } else {
        // Old system
        const { subject, book: oldBook, chapter: oldChapter } = getUrlParams();
        
        // Validate parameters before making request
        if (!subject || !oldBook || !oldChapter) {
          console.error('Missing required URL parameters for old system');
          container.innerHTML = `<p class="text-center text-red-600 dark:text-red-400 mt-6">‚ùå Missing required parameters (subject, book, chapter).</p>`;
          document.getElementById('loader').classList.add('hidden');
          return;
        }
        
        try {
          const res = await fetch(`./question/subjects/${subject}/${oldBook}-${oldChapter}.json`, { cache: 'no-store' });
          const raw = await res.json();
          session.fullData = (raw || []).map((q, i) => ({ ...q, _idx: i }));
        } catch (err) {
          console.error(err);
          container.innerHTML = `<p class="text-center text-red-600 dark:text-red-400 mt-6">‚ùå Questions coming soon or failed to load.</p>`;
          document.getElementById('loader').classList.add('hidden');
          return;
        }
      }
      
      const hasProgress = loadFromLocalStorage();
      session.data = session.fullData.slice();

      if (hasProgress) {
        const notification = document.createElement('div');
        notification.className = 'saved-badge';
        notification.innerHTML = '<i class="fas fa-history mr-2"></i>Progress Restored!';
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      }
      
      if (session.fullData.length === 0) {
        container.innerHTML = `<p class="text-center text-amber-600 dark:text-amber-400 mt-6">üìö No questions available for this selection yet.</p>`;
        document.getElementById('loader').classList.add('hidden');
        return;
      }
      
      renderPage();
      updateQuestionGrid();
      
      // Hide loader after everything is loaded
      document.getElementById('loader').classList.add('hidden');
    }

    // Global error handlers
    window.addEventListener('unhandledrejection', function(event) {
      console.error('Unhandled promise rejection:', event.reason);
      event.preventDefault();
      
      // Hide loader if it's visible
      const loader = document.getElementById('loader');
      if (loader && !loader.classList.contains('hidden')) {
        loader.classList.add('hidden');
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('fullscreen-prompt').classList.remove('hidden');
    });
  </script>
</body>
</html>
