<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UPSC Notes - Reader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: {
              50: "#fef3e2", 100: "#fde7c5", 200: "#fbcf8b", 300: "#f9b751",
              400: "#f7a027", 500: "#f59e0b", 600: "#d97706", 700: "#b45309",
              800: "#92400e", 900: "#78350f"
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" defer></script>
  <style>
    body { font-family: Georgia, serif; line-height: 1.8; font-size: 18px; }
    .reading-highlight { background: linear-gradient(120deg, #f59e0b 0%, #fbbf24 100%); color: white; padding: 2px 6px; border-radius: 4px; animation: pulse 0.6s ease-in-out; font-weight: 600; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
    @keyframes fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fade-in 0.5s ease-out; }
    .selection-tooltip { position: absolute; background: linear-gradient(135deg, #1f2937 0%, #374151 100%); color: white; padding: 8px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); display: none; z-index: 1000; gap: 8px; }
    .selection-tooltip button { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 13px; display: flex; align-items: center; gap: 6px; }
    .selection-tooltip button:hover { background: rgba(245, 158, 11, 0.9); transform: translateY(-2px); }
    #translateMenu button:hover { background: rgba(245, 158, 11, 0.9); transform: translateX(4px); }
    #markdownContent { max-width: 750px; margin: 0 auto; padding: 2rem 1.5rem; min-height: calc(100vh - 120px); }
    #markdownContent h1 { font-size: 2.5rem; font-weight: 700; margin: 2rem 0 1rem; background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
    #markdownContent h2 { font-size: 2rem; font-weight: 600; margin: 1.8rem 0 1rem; color: #f59e0b; border-bottom: 2px solid rgba(245, 158, 11, 0.2); padding-bottom: 0.5rem; }
    #markdownContent h3 { font-size: 1.5rem; font-weight: 600; margin: 1.5rem 0 0.8rem; color: #d97706; }
    #markdownContent p { margin: 1.2rem 0; text-align: justify; }
    #markdownContent ul, #markdownContent ol { margin: 1rem 0; padding-left: 2rem; }
    #markdownContent li { margin: 0.5rem 0; }
    #markdownContent blockquote { border-left: 4px solid #f59e0b; padding: 1rem 1.5rem; margin: 1.5rem 0; background: rgba(245, 158, 11, 0.05); border-radius: 0 8px 8px 0; font-style: italic; }
    #markdownContent code { background: rgba(245, 158, 11, 0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
    #markdownContent pre { background: #1f2937; padding: 1.5rem; border-radius: 12px; overflow-x: auto; margin: 1.5rem 0; }
    #markdownContent pre code { background: none; color: #e5e7eb; padding: 0; }
    #markdownContent img { max-width: 100%; height: auto; border-radius: 12px; margin: 2rem auto; display: block; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); transition: transform 0.3s ease; cursor: zoom-in; }
    #markdownContent img:hover { transform: scale(1.02); }
    #markdownContent table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); border-radius: 8px; overflow: hidden; }
    #markdownContent th { background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: white; padding: 12px; text-align: left; }
    #markdownContent td { padding: 12px; border-bottom: 1px solid rgba(0, 0, 0, 0.05); }
    #markdownContent tr:hover { background: rgba(245, 158, 11, 0.05); }
    .dark #markdownContent h2 { color: #fbbf24; border-bottom-color: rgba(251, 191, 36, 0.2); }
    .dark #markdownContent h3 { color: #fcd34d; }
    .dark #markdownContent blockquote { background: rgba(245, 158, 11, 0.1); border-left-color: #fbbf24; }
    .dark #markdownContent code { background: rgba(245, 158, 11, 0.15); }
    .dark #markdownContent td { border-bottom-color: rgba(255, 255, 255, 0.1); }
    #readingProgress { position: fixed; top: 0; left: 0; height: 4px; background: linear-gradient(90deg, #f59e0b 0%, #f97316 100%); width: 0%; z-index: 9999; transition: width 0.1s ease; }
    .control-panel { position: fixed; bottom: 2rem; right: 2rem; display: flex; flex-direction: column; gap: 12px; z-index: 999; }
    .control-btn { width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: white; border: none; box-shadow: 0 4px 16px rgba(245, 158, 11, 0.4); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .control-btn:hover { transform: translateY(-4px) scale(1.05); box-shadow: 0 8px 24px rgba(245, 158, 11, 0.6); }
    .control-btn.active { animation: pulse-soft 1.5s ease-in-out infinite; }
    @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
    .settings-panel { position: fixed; right: -400px; top: 0; bottom: 0; width: 380px; background: white; box-shadow: -4px 0 24px rgba(0, 0, 0, 0.2); transition: right 0.3s ease; z-index: 1001; overflow-y: auto; padding: 2rem; }
    .dark .settings-panel { background: #1f2937; }
    .settings-panel.open { right: 0; }
    .settings-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; backdrop-filter: blur(4px); }
    .settings-overlay.active { display: block; }
    .skeleton { background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%); background-size: 200% 100%; animation: loading 1.5s ease-in-out infinite; border-radius: 8px; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    ::selection { background: rgba(245, 158, 11, 0.3); }
    @media (max-width: 768px) { 
      body { font-size: 16px; } 
      #markdownContent { padding: 1.5rem 1rem; } 
      #markdownContent h1 { font-size: 2rem; } 
      #markdownContent h2 { font-size: 1.5rem; } 
      .control-panel { bottom: 1rem; right: 1rem; flex-direction: row; flex-wrap: wrap; } 
      .control-btn { width: 48px; height: 48px; font-size: 18px; } 
      .settings-panel { width: 100%; right: -100%; } 
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-orange-50 to-amber-50 dark:from-gray-900 dark:via-gray-800 dark:to-slate-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
  <div id="readingProgress"></div>
  <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
    <div class="absolute top-20 left-10 w-72 h-72 bg-amber-300/20 dark:bg-amber-500/10 rounded-full blur-3xl" style="animation: float 3s ease-in-out infinite;"></div>
    <div class="absolute bottom-20 right-10 w-96 h-96 bg-orange-300/20 dark:bg-orange-500/10 rounded-full blur-3xl" style="animation: float 3s ease-in-out infinite; animation-delay: 1s;"></div>
  </div>
  
  <header class="sticky top-0 z-50 backdrop-blur-lg bg-white/80 dark:bg-gray-900/80 border-b border-gray-200 dark:border-gray-700 shadow-sm">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <a href="syllabus.html" class="flex items-center gap-2 text-gray-700 dark:text-gray-300 hover:text-amber-600 dark:hover:text-amber-400 transition-colors">
        <i class="fas fa-arrow-left"></i>
        <span class="font-medium">Back to Syllabus</span>
      </a>
      <div class="flex items-center gap-2">
        <button id="themeToggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
          <i class="fas fa-moon dark:hidden"></i>
          <i class="fas fa-sun hidden dark:inline"></i>
        </button>
        <span id="readingTime" class="text-sm text-gray-600 dark:text-gray-400 hidden sm:inline">
          <i class="fas fa-clock mr-1"></i>
          <span id="readingTimeText">5 min read</span>
        </span>
      </div>
    </div>
  </header>
  
  <main class="relative z-10">
    <article id="markdownContent" class="animate-fade-in">
      <div id="loadingSkeleton">
        <div class="skeleton h-12 w-3/4 mb-6"></div>
        <div class="skeleton h-4 w-full mb-3"></div>
        <div class="skeleton h-4 w-full mb-3"></div>
        <div class="skeleton h-4 w-5/6 mb-6"></div>
        <div class="skeleton h-8 w-1/2 mb-4"></div>
        <div class="skeleton h-4 w-full mb-3"></div>
        <div class="skeleton h-4 w-full mb-3"></div>
        <div class="skeleton h-4 w-4/5"></div>
      </div>
    </article>
  </main>
  
  <div id="selectionTooltip" class="selection-tooltip">
    <button id="askAiBtn" title="Ask AI"><i class="fas fa-robot"></i><span>Ask AI</span></button>
    <button id="translateBtn" title="Translate"><i class="fas fa-language"></i><span>Translate</span></button>
    <button id="explainBtn" title="Explain"><i class="fas fa-lightbulb"></i><span>Explain</span></button>
    <button id="copyBtn" title="Copy"><i class="fas fa-copy"></i><span>Copy</span></button>
    <button id="speakBtn" title="Read Aloud"><i class="fas fa-volume-up"></i><span>Read</span></button>
  </div>
  
  <div id="translateMenu" style="position: absolute; background: linear-gradient(135deg, #1f2937 0%, #374151 100%); color: white; padding: 8px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); display: none; z-index: 1001; flex-direction: column; gap: 4px; min-width: 140px;">
    <button id="translateKannada" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 13px; display: flex; align-items: center; gap: 6px; width: 100%; text-align: left;">
      <i class="fas fa-language text-amber-400"></i><span>ಕನ್ನಡ (Kannada)</span>
    </button>
    <button id="translateMarathi" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 13px; display: flex; align-items: center; gap: 6px; width: 100%; text-align: left;">
      <i class="fas fa-language text-amber-400"></i><span>मराठी (Marathi)</span>
    </button>
  </div>
  
  <div class="control-panel">
    <button id="readAloudBtn" class="control-btn" title="Read Aloud">
      <i class="fas fa-play" id="readAloudIcon"></i>
    </button>
    <button id="settingsBtn" class="control-btn" title="Settings">
      <i class="fas fa-cog"></i>
    </button>
    <button id="scrollTopBtn" class="control-btn" title="Scroll to Top">
      <i class="fas fa-arrow-up"></i>
    </button>
  </div>
  
  <div id="settingsOverlay" class="settings-overlay"></div>
  
  <div id="settingsPanel" class="settings-panel">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-2xl font-bold text-gray-900 dark:text-white">
        <i class="fas fa-cog text-amber-500 mr-2"></i>Settings
      </h3>
      <button id="closeSettings" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    
    <div class="mb-6">
      <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
        <i class="fas fa-font text-amber-500 mr-2"></i>Font Family
      </label>
      <select id="fontSelector" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-amber-500">
        <option value="Georgia, serif">Georgia (Serif)</option>
        <option value="'Segoe UI', sans-serif">Segoe UI</option>
        <option value="'Inter', sans-serif">Inter</option>
        <option value="'Roboto', sans-serif">Roboto</option>
        <option value="'Times New Roman', serif">Times New Roman</option>
      </select>
    </div>
    
    <div class="mb-6">
      <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
        <i class="fas fa-text-height text-amber-500 mr-2"></i>Font Size: <span id="fontSizeValue">18px</span>
      </label>
      <input type="range" id="fontSizeSlider" min="14" max="24" value="18" class="w-full">
    </div>
    
    <div class="mb-6">
      <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
        <i class="fas fa-tachometer-alt text-amber-500 mr-2"></i>Speed: <span id="speedValue">1.0x</span>
      </label>
      <input type="range" id="speedSlider" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full">
    </div>
    
    <div class="mb-6">
      <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
        <i class="fas fa-palette text-amber-500 mr-2"></i>Theme
      </label>
      <div class="grid grid-cols-2 gap-2">
        <button class="theme-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:border-amber-500 transition-colors" data-theme="light">
          <i class="fas fa-sun text-yellow-500"></i>
          <span class="block text-xs mt-1">Light</span>
        </button>
        <button class="theme-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:border-amber-500 transition-colors" data-theme="dark">
          <i class="fas fa-moon text-blue-500"></i>
          <span class="block text-xs mt-1">Dark</span>
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  <script>
    let isReading = false, isPaused = false, currentUtterance = null, readingSpeed = 1.0;
    let femaleVoice = null, wordIndex = 0, words = [], selectedText = "";

    document.addEventListener("DOMContentLoaded", async () => {
      await loadMarkdown();
      initializeControls();
      initializeTextSelection();
      initializeReadingProgress();
      loadSettings();
      calculateReadingTime();
      loadVoices();
      setupVisibilityHandler();
    });

    function loadVoices() {
      const voices = window.speechSynthesis.getVoices();
      femaleVoice = voices.find(v => v.name.includes("Female") || v.name.includes("Zira") || v.name.includes("Microsoft Heera") || (v.name.includes("Google") && v.lang.startsWith("en"))) || voices.find(v => v.lang.startsWith("en"));
      if (voices.length === 0) setTimeout(loadVoices, 100);
    }
    
    if (window.speechSynthesis.onvoiceschanged !== undefined) {
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }

    function setupVisibilityHandler() {
      document.addEventListener("visibilitychange", () => { if (document.hidden && isReading) stopReading(); });
      window.addEventListener("beforeunload", () => { if (isReading) stopReading(); });
    }

    async function loadMarkdown() {
      const urlParams = new URLSearchParams(window.location.search);
      const mdUrl = urlParams.get("mdUrl");
      const content = document.getElementById("markdownContent");
      const skeleton = document.getElementById("loadingSkeleton");
      
      if (!mdUrl) {
        if (skeleton) skeleton.remove();
        content.innerHTML = '<div class="text-center py-12"><i class="fas fa-exclamation-triangle text-amber-500 text-4xl mb-4"></i><p class="text-xl text-gray-600 dark:text-gray-400">No file specified</p><p class="text-sm text-gray-500 mt-2">Please select a topic from the syllabus page</p></div>';
        return;
      }
      
      try {
        const res = await fetch(mdUrl);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const mdText = await res.text();
        const html = marked.parse(mdText);
        if (skeleton) {
          skeleton.style.opacity = "0";
          setTimeout(() => {
            skeleton.remove();
            content.innerHTML = html;
            if (window.MathJax) MathJax.typeset();
            if (window.Prism) Prism.highlightAll();
          }, 300);
        }
      } catch (error) {
        if (skeleton) skeleton.remove();
        content.innerHTML = `<div class="text-center py-12"><i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i><p class="text-xl text-gray-600 dark:text-gray-400">Failed to load</p><p class="text-sm text-gray-500 mt-2">${error.message}</p></div>`;
      }
    }

    function initializeControls() {
      document.getElementById("readAloudBtn").addEventListener("click", toggleReadAloud);
      document.getElementById("settingsBtn").addEventListener("click", () => {
        document.getElementById("settingsPanel").classList.add("open");
        document.getElementById("settingsOverlay").classList.add("active");
        document.body.style.overflow = "hidden";
      });
      document.getElementById("closeSettings").addEventListener("click", closeSettings);
      document.getElementById("settingsOverlay").addEventListener("click", closeSettings);
      document.getElementById("scrollTopBtn").addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
      document.getElementById("themeToggle").addEventListener("click", () => {
        document.documentElement.classList.toggle("dark");
        localStorage.setItem("upsc_theme", document.documentElement.classList.contains("dark") ? "dark" : "light");
      });
      document.getElementById("fontSelector").addEventListener("change", (e) => {
        document.body.style.fontFamily = e.target.value;
        localStorage.setItem("reader_font", e.target.value);
      });
      document.getElementById("fontSizeSlider").addEventListener("input", (e) => {
        document.body.style.fontSize = e.target.value + "px";
        document.getElementById("fontSizeValue").textContent = e.target.value + "px";
        localStorage.setItem("reader_fontSize", e.target.value);
      });
      document.getElementById("speedSlider").addEventListener("input", (e) => {
        readingSpeed = parseFloat(e.target.value);
        document.getElementById("speedValue").textContent = readingSpeed.toFixed(1) + "x";
        localStorage.setItem("reader_speed", readingSpeed);
      });
      document.querySelectorAll(".theme-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const theme = btn.dataset.theme;
          document.querySelectorAll(".theme-btn").forEach(b => b.classList.remove("border-amber-500"));
          btn.classList.add("border-amber-500");
          if (theme === "dark") document.documentElement.classList.add("dark");
          else document.documentElement.classList.remove("dark");
          localStorage.setItem("upsc_theme", theme);
        });
      });
    }

    function toggleReadAloud() {
      const btn = document.getElementById("readAloudBtn");
      const icon = document.getElementById("readAloudIcon");
      if (isReading && !isPaused) {
        window.speechSynthesis.pause();
        isPaused = true;
        icon.className = "fas fa-play";
        btn.classList.remove("active");
      } else if (isPaused) {
        window.speechSynthesis.resume();
        isPaused = false;
        icon.className = "fas fa-pause";
        btn.classList.add("active");
      } else startReading();
    }

    function startReading() {
      const content = document.getElementById("markdownContent");
      const textElements = content.querySelectorAll("p, h1, h2, h3, h4, h5, h6, li, blockquote");
      if (textElements.length === 0) return;
      clearHighlights();
      isReading = true;
      isPaused = false;
      wordIndex = 0;
      document.getElementById("readAloudIcon").className = "fas fa-pause";
      document.getElementById("readAloudBtn").classList.add("active");
      readNextElement(textElements, 0);
    }

    function readNextElement(elements, index) {
      if (index >= elements.length) { stopReading(); return; }
      const element = elements[index];
      const text = element.textContent.trim();
      if (!text) { readNextElement(elements, index + 1); return; }
      words = text.split(/\s+/);
      wordIndex = 0;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = readingSpeed;
      utterance.pitch = 1;
      utterance.volume = 1;
      if (femaleVoice) utterance.voice = femaleVoice;
      utterance.lang = "en-IN";
      currentUtterance = utterance;
      utterance.onboundary = (event) => {
        if (event.name === "word") {
          const word = words[wordIndex];
          if (word && element.innerHTML) {
            try { highlightWord(element, word); wordIndex++; } 
            catch (e) { console.error("Highlight error:", e); }
          }
        }
      };
      utterance.onend = () => { clearElementHighlight(element); if (isReading) readNextElement(elements, index + 1); };
      utterance.onerror = () => stopReading();
      window.speechSynthesis.speak(utterance);
    }

    function highlightWord(element, word) {
      clearElementHighlight(element);
      const regex = new RegExp(`\\b(${word.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})\\b`, "i");
      const html = element.innerHTML;
      const highlighted = html.replace(regex, '<span class="reading-highlight">$1</span>');
      if (html !== highlighted) {
        element.innerHTML = highlighted;
        const highlightedEl = element.querySelector(".reading-highlight");
        if (highlightedEl) highlightedEl.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }

    function clearElementHighlight(element) {
      const highlighted = element.querySelectorAll(".reading-highlight");
      highlighted.forEach(el => {
        const text = el.textContent;
        const textNode = document.createTextNode(text);
        el.parentNode.replaceChild(textNode, el);
      });
      element.normalize();
    }

    function stopReading() {
      window.speechSynthesis.cancel();
      clearHighlights();
      isReading = false;
      isPaused = false;
      document.getElementById("readAloudIcon").className = "fas fa-play";
      document.getElementById("readAloudBtn").classList.remove("active");
    }

    function clearHighlights() {
      document.querySelectorAll(".reading-highlight").forEach(el => {
        const text = el.textContent;
        const textNode = document.createTextNode(text);
        el.parentNode.replaceChild(textNode, el);
      });
    }

    function initializeTextSelection() {
      const tooltip = document.getElementById("selectionTooltip");
      const translateMenu = document.getElementById("translateMenu");
      document.addEventListener("mouseup", () => {
        setTimeout(() => {
          selectedText = window.getSelection().toString().trim();
          if (selectedText.length > 0 && selectedText.length < 500) {
            const range = window.getSelection().getRangeAt(0);
            const rect = range.getBoundingClientRect();
            tooltip.style.display = "flex";
            tooltip.style.left = rect.left + (rect.width / 2) + "px";
            tooltip.style.top = rect.top + window.scrollY - 60 + "px";
            tooltip.style.transform = "translateX(-50%)";
            translateMenu.style.display = "none";
          } else {
            tooltip.style.display = "none";
            translateMenu.style.display = "none";
          }
        }, 10);
      });
      document.getElementById("askAiBtn").addEventListener("click", () => {
        window.open("https://chatgpt.com/?q=" + encodeURIComponent(selectedText), "_blank");
        tooltip.style.display = "none";
      });
      document.getElementById("translateBtn").addEventListener("click", (e) => {
        const rect = e.target.getBoundingClientRect();
        translateMenu.style.display = "flex";
        translateMenu.style.left = rect.left + "px";
        translateMenu.style.top = rect.bottom + window.scrollY + 8 + "px";
        tooltip.style.display = "none";
      });
      document.getElementById("translateKannada").addEventListener("click", () => {
        window.open("https://translate.google.com/?sl=en&tl=kn&text=" + encodeURIComponent(selectedText), "_blank");
        translateMenu.style.display = "none";
      });
      document.getElementById("translateMarathi").addEventListener("click", () => {
        window.open("https://translate.google.com/?sl=en&tl=mr&text=" + encodeURIComponent(selectedText), "_blank");
        translateMenu.style.display = "none";
      });
      document.getElementById("explainBtn").addEventListener("click", () => {
        window.open("https://www.google.com/search?q=" + encodeURIComponent("Explain: " + selectedText), "_blank");
        tooltip.style.display = "none";
      });
      document.getElementById("copyBtn").addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(selectedText);
          const btn = document.getElementById("copyBtn");
          btn.innerHTML = '<i class="fas fa-check"></i><span>Copied!</span>';
          setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-copy"></i><span>Copy</span>';
            tooltip.style.display = "none";
          }, 1500);
        } catch (err) { console.error("Failed:", err); }
      });
      document.getElementById("speakBtn").addEventListener("click", () => {
        const utterance = new SpeechSynthesisUtterance(selectedText);
        utterance.rate = readingSpeed;
        if (femaleVoice) utterance.voice = femaleVoice;
        utterance.lang = "en-IN";
        window.speechSynthesis.speak(utterance);
        tooltip.style.display = "none";
      });
      document.addEventListener("click", (e) => {
        if (!tooltip.contains(e.target) && !translateMenu.contains(e.target) && window.getSelection().toString().trim().length === 0) {
          tooltip.style.display = "none";
          translateMenu.style.display = "none";
        }
      });
    }

    function initializeReadingProgress() {
      const progressBar = document.getElementById("readingProgress");
      window.addEventListener("scroll", () => {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight - windowHeight;
        const scrolled = window.scrollY;
        const progress = (scrolled / documentHeight) * 100;
        progressBar.style.width = Math.min(progress, 100) + "%";
      });
    }

    function closeSettings() {
      document.getElementById("settingsPanel").classList.remove("open");
      document.getElementById("settingsOverlay").classList.remove("active");
      document.body.style.overflow = "";
    }

    function loadSettings() {
      const savedFont = localStorage.getItem("reader_font");
      const savedFontSize = localStorage.getItem("reader_fontSize");
      const savedSpeed = localStorage.getItem("reader_speed");
      const savedTheme = localStorage.getItem("upsc_theme");
      if (savedFont) {
        document.getElementById("fontSelector").value = savedFont;
        document.body.style.fontFamily = savedFont;
      }
      if (savedFontSize) {
        document.getElementById("fontSizeSlider").value = savedFontSize;
        document.body.style.fontSize = savedFontSize + "px";
        document.getElementById("fontSizeValue").textContent = savedFontSize + "px";
      }
      if (savedSpeed) {
        readingSpeed = parseFloat(savedSpeed);
        document.getElementById("speedSlider").value = savedSpeed;
        document.getElementById("speedValue").textContent = parseFloat(savedSpeed).toFixed(1) + "x";
      }
      if (savedTheme) {
        if (savedTheme === "dark") document.documentElement.classList.add("dark");
        const themeBtn = document.querySelector(`[data-theme="${savedTheme}"]`);
        if (themeBtn) themeBtn.classList.add("border-amber-500");
      }
    }

    function calculateReadingTime() {
      setTimeout(() => {
        const content = document.getElementById("markdownContent");
        if (content && content.innerText) {
          const words = content.innerText.split(/\s+/).length;
          const minutes = Math.ceil(words / 200);
          document.getElementById("readingTimeText").textContent = minutes + " min read";
        }
      }, 500);
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closeSettings();
        document.getElementById("selectionTooltip").style.display = "none";
        document.getElementById("translateMenu").style.display = "none";
      }
      if (e.key === " " && !e.target.matches("input, textarea, select")) {
        e.preventDefault();
        toggleReadAloud();
      }
    });
  </script>
</body>
</html>
